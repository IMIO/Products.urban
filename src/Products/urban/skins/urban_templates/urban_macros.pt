<div metal:define-macro="goUpOneLevelMacro" i18n:domain="urban">
<br />
<a class="no_underline" href="#" tal:attributes="href python: context.aq_inner.aq_parent.absolute_url()"><img src="goback.png" />&nbsp;<span i18n:translate="back_to_licence">Go back to the licence</span></a>
</div>

<div metal:define-macro="urbanEventDataMacro" i18n:domain="urban">
 <fieldset><strong><legend i18n:translate="event_data">Event data</legend></strong>
  <table class="no-style-table">
    <tr valign="top">
     <td>
      <strong tal:content="python: context.eventDateLabel()">Event date label</strong>:&nbsp;&nbsp;&nbsp;&nbsp;
     </td>
     <tal:manage_show_nc_if_needed define="value python: getattr(context, 'eventDate')">
      <td tal:condition="value">
       <metal:myfield use-macro="python: context.widget('eventDate', mode='view')" />
      </td>
      <td tal:condition="not: value">
       <span tal:condition="not: value" class="discreet" i18n:translate="content_none">None</span>
      </td>
     </tal:manage_show_nc_if_needed>
    </tr>
    <tal:evtfield repeat="field fields" define="evtdata view/getData;
                                                context python: evtdata[0];
                                                fields python: evtdata[1];">
    <tr valign="top">
     <td>
      <strong i18n:translate="" tal:content="python: 'urban_label_' + field">Optional field label</strong>:&nbsp;&nbsp;&nbsp;&nbsp;
     </td>
     <tal:manage_show_nc_if_needed define="value python: getattr(context, field)">
      <td tal:condition="value">
       <tal:no_long_text condition="python: not 'Text' in field">
        <metal:myfield use-macro="python: context.widget(field, mode='view')" />
       </tal:no_long_text>
       <!-- For long text, just show the first words and add a link to see the entire text -->
       <tal:long_text condition="python: 'Text' in field">
        <tal:block define="infos python: context.portal_urban.getTextToShow(context, field);
                           isTooLong python: infos[0];
                           textToShow python: infos[1];">
         <span tal:condition="isTooLong" id="urban-claims-text">
          <span tal:replace="structure textToShow">Content...</span>
          <br /><a class="link-overlay" href="@@longtextview" tal:attributes="href python: context.absolute_url() + '/@@longtextview?field=' + field" i18n:translate="">See more...</a>
         </span>
         <tal:block condition="not: isTooLong">
          <metal:myfield use-macro="python: context.widget(field, mode='view')" />
         </tal:block>
        </tal:block>
       </tal:long_text>
      </td>
      <td tal:condition="not: value">
        <span tal:condition="not: value" class="discreet" i18n:translate="content_none">None</span>
      </td>
     </tal:manage_show_nc_if_needed>
    </tr>
    </tal:evtfield>
  </table>
 </fieldset>
</div>

<div metal:define-macro="urbanEventGenerateDocumentMacro" i18n:domain="urban">
 <fieldset tal:define="templateObjs python: linkedUrbanEventType.getTemplates();
                       mayAddUrbanEvent view/mayAddUrbanEvent">
  <strong><legend i18n:translate="generate_a_linked_doc">Generate a linked document</legend></strong>
  <tal:templateObjs condition="python: mayAddUrbanEvent and templateObjs">
   <tal:loopEventType repeat="templateObj templateObjs">
    <a href="#" tal:attributes="href python: context.absolute_url() + '/createUrbanDoc?urban_template_uid=%s&urban_event_uid=%s' % (templateObj.UID(), here.UID())" tal:content="templateObj/Title">Template title</a><br />
   </tal:loopEventType>
  </tal:templateObjs>
  <tal:no_templateObjs condition="not: templateObjs">
   <p class="discreet" i18n:translate="no_document_to_generate">No document to generate</p>
  </tal:no_templateObjs>
  <tal:not_may_add_urbanevent condition="not: mayAddUrbanEvent">
   <p class="discreet" i18n:translate="not_permitted_to_add_urbanevent">You can not add an UrbanEvent</p>
  </tal:not_may_add_urbanevent>
 </fieldset>
</div>

<div metal:define-macro="urbanEventAddAnnexMacro" i18n:domain="urban">
 <fieldset tal:define="mayAddAnnex view/mayAddAnnex"><strong><legend i18n:translate="add_an_annex">Add an annex</legend></strong>
  <form tal:condition="mayAddAnnex" name="quickAdd" action="createObject" method="post">
    <input name="type_name" value="File" type="hidden">
    <input i18n:attributes="value" class="context" id="event" value="add_an_annex" type="submit">
   </form>
   <tal:not_may_add_annex condition="not: mayAddAnnex">
    <p class="discreet" i18n:translate="not_permitted_to_add_annex">You can not add an annex</p>
   </tal:not_may_add_annex>
  </fieldset>
</div>

<div metal:define-macro="urbanInquiriesMacro" i18n:domain="urban"
     tal:define="ctype python: context.portal_types.getTypeInfo('Inquiry');
                 inquiries here/getInquiriesForDisplay;
                 member context/@@plone_portal_state/member;">
<fieldset tal:repeat="inquiry inquiries"><legend><img src="#" tal:attributes="src ctype/getIcon" />&nbsp;<span i18n:translate="inquiry_title_and_number">Inquiry <span i18n:name="number" tal:content="repeat/inquiry/number"></span></span></legend>
<tal:comment replace="nothing">Do not show the actions on the Licence object representing the first inquiry, only on following ones wich are real Inquiry objects</tal:comment>
<tal:actions condition="python: not repeatindex == 0" define="repeatindex repeat/inquiry/index;
                                  thisObject python: inquiry;
                                  needExternalEdition python:False;
                                  actionsToHide python: ('transitions',);">
     <span metal:use-macro="here/urban_macros/macros/urbanActionsMacro" />
</tal:actions>
<table class="no-style-table">
 <tr>
  <td valign="top"><b><span i18n:translate="urban_label_derogation">Derogations</span>:</b></td>
  <td width="2%"></td>
  <td valign="top"><metal:myfield use-macro="python:inquiry.widget('derogation', mode='view')" /><span tal:condition="not: inquiry/getDerogation" class="discreet" i18n:translate="content_none">None</span></td>
 </tr>
 <tr tal:condition="python: context.attributeIsUsed('derogationDetails')">
  <td valign="top"><b><span i18n:translate="urban_label_derogationDetails">Derogations details</span>:</b></td>
  <td width="2%"></td>
  <td valign="top"><tal:block replace="structure inquiry/getDerogationDetails" /><span tal:condition="not: inquiry/getDerogationDetails" class="discreet" i18n:translate="content_none">None</span></td>
 </tr>
 <tr>
  <td valign="top"><b><span i18n:translate="urban_label_investigationArticles">Investigation articles</span>:</b></td>
  <td width="2%"></td>
  <td valign="top"><metal:myfield use-macro="python:inquiry.widget('investigationArticles', mode='view')" /><span tal:condition="not: inquiry/getInvestigationArticles" class="discreet" i18n:translate="content_none">None</span></td>
 </tr>
 <tr>
  <td valign="top"><b><span i18n:translate="urban_label_investigationStart">from</span>:</b></td>
  <td width="2%"></td>
  <td valign="top"><metal:myfield use-macro="python:inquiry.widget('investigationStart', mode='view')" /><span tal:condition="not: inquiry/getInvestigationStart" class="discreet" i18n:translate="content_none">None</span></td>
 </tr>
 <tr>
  <td valign="top"><b><span i18n:translate="urban_label_investigationEnd">to</span>:</b></td>
  <td width="2%"></td>
  <td valign="top"><metal:myfield use-macro="python:inquiry.widget('investigationEnd', mode='view')" /><span tal:condition="not: inquiry/getInvestigationEnd" class="discreet" i18n:translate="content_none">None</span></td>
 </tr>
 <tr tal:condition="python: context.attributeIsUsed('investigationDetails')">
  <td valign="top"><b><span i18n:translate="urban_label_investigationDetails">Investigation details</span>:</b></td>
  <td width="2%"></td>
  <td valign="top"><tal:block replace="structure inquiry/getInvestigationDetails" /><span tal:condition="not: inquiry/getInvestigationDetails" class="discreet" i18n:translate="content_none">None</span></td>
 </tr>
 <tr tal:condition="python: context.attributeIsUsed('investigationReasons')">
  <td valign="top"><b><span i18n:translate="urban_label_investigationReasons">Investigation reasons</span>:</b></td>
  <td width="2%"></td>
  <td valign="top"><tal:block replace="structure inquiry/getInvestigationReasons" /><span tal:condition="not: inquiry/getInvestigationReasons" class="discreet" i18n:translate="content_none">None</span></td>
 </tr>
 <tr>
  <td valign="top"><b><span i18n:translate="urban_label_solicitOpinionsTo">Solicit opinion to</span>:</b></td>
  <td width="2%"></td>
  <td valign="top"><metal:myfield use-macro="python:inquiry.widget('solicitOpinionsTo', mode='view')" /><span tal:condition="not: inquiry/getSolicitOpinionsTo" class="discreet" i18n:translate="content_none">None</span></td>
 </tr>
 <tr>
  <td valign="top"><b><span i18n:translate="urban_label_investigationOralReclamationNumber">Number of oral reclamations</span>:</b></td>
  <td width="2%"></td>
  <td valign="top"><metal:myfield use-macro="python:inquiry.widget('investigationOralReclamationNumber', mode='view')" /></td>
 </tr>
 <tr>
  <td valign="top"><b><span i18n:translate="urban_label_investigationWriteReclamationNumber">Number of write reclamations</span>:</b></td>
  <td width="2%"></td>
  <td valign="top"><metal:myfield use-macro="python:inquiry.widget('investigationWriteReclamationNumber', mode='view')" /></td>
 </tr>
 <tal:comment replace="nothing">Link to the UrbanEventInquiry if exists</tal:comment>
 <tr>
  <td valign="top"><b><span i18n:translate="urban_linked_urbaneventinquiry">Linked urban event inquiry</span>:</b></td>
  <td width="2%"></td>
  <td valign="top" tal:define="linkedUrbanEventInquiry python: inquiry.getLinkedUrbanEventInquiry();">
   <a tal:condition="python: linkedUrbanEventInquiry" href="#" tal:attributes="href python:linkedUrbanEventInquiry.absolute_url()" i18n:translate="urban_link_to_the_linked_urbaneventinquiry">Click here to access the linked urban event inquiry</a>
   <span tal:condition="python: not linkedUrbanEventInquiry" class="discreet" i18n:translate="content_no_urbaneventinquiry">There is no UrbanEventInquiry linked to this inquiry</span>
  </td>
 </tr>
</table>
</fieldset>

<form tal:condition="python: member.has_permission('urban: Add Inquiry', context)" i18n:domain="urban" name="quickAdd" tal:attributes="action python: context.absolute_url() + '/createObject'" action="createObject" method="post">
 <img src="#" title="#" tal:attributes="src python: ctype.getIcon(); title ctype/description" i18n:attributes="title" />
 <input type="hidden" name="type_name" value="#" tal:attributes="value ctype/id" />
 <input type="submit" class="context" id="event" value="add_an_inquiry" i18n:attributes="value" />
</form>
</div>

<div metal:define-macro="urbanFolderManagerMacro" i18n:domain="urban" tal:define="folderManagers here/getFoldermanagers">
 <tal:loop repeat="folderManager folderManagers" tal:condition="folderManagers">
   <span tal:content="folderManager/Title">Treating agent name</span><br />
 </tal:loop>
 <p tal:condition="not: folderManagers" class="discreet" i18n:translate="no_foldermanager_defined">No folder manager defined</p>
</div>

<div metal:define-macro="urbanArchitectsMacro" i18n:domain="urban" tal:define="architects here/getArchitects">
<tal:loop repeat="architect architects" tal:condition="architects">
<div class="#" tal:define="oddrow repeat/architect/odd;" tal:attributes="class python: oddrow and 'even' or 'odd'">
  <a href="#" tal:attributes="href python: architect.absolute_url() + '?came_from_licence_uid=' + context.UID()">
   <span tal:replace="python: context.displayValue(architect.Vocabulary('personTitle')[0], architect.getPersonTitle())" />
   <span tal:replace="architect/getName1|nothing" />
   <span tal:replace="architect/getName2|nothing" />
   <span tal:condition="architect/getSociety" tal:replace="python: '(' + architect.getSociety() + ')'" />
  </a>
 <br />
 <span tal:content="python: architect.getStreet()+' '+architect.getNumber()" /><br />
 <span tal:content="python: architect.getZipcode()+' '+architect.getCity()" /><br />
</div>
</tal:loop>
</div>

<div metal:define-macro="urbanGeometriciansMacro" i18n:domain="urban" tal:define="geometricians here/getGeometricians">
<tal:loop repeat="geometrician geometricians" tal:condition="geometricians">
<div class="#" tal:define="oddrow repeat/geometrician/odd;" tal:attributes="class python: oddrow and 'even' or 'odd'">
  <a href="#" tal:attributes="href python: geometrician.absolute_url() + '?came_from_licence_uid=' + context.UID()">
   <span tal:replace="python: context.displayValue(geometrician.Vocabulary('personTitle')[0], geometrician.getPersonTitle())" />
   <span tal:replace="geometrician/getName1|nothing" />
   <span tal:replace="geometrician/getName2|nothing" />
   <span tal:condition="geometrician/getSociety" tal:replace="python: '(' + geometrician.getSociety() + ')'" />
  </a>
 <span tal:content="python: geometrician.getStreet()+' '+geometrician.getNumber()" /><br />
 <span tal:content="python: geometrician.getZipcode()+' '+geometrician.getCity()" /><br />
</div>
</tal:loop>
</div>

<div metal:define-macro="urbanNotariesMacro" i18n:domain="urban" tal:define="notaries here/getNotaryContact">
<tal:loop repeat="notary notaries">
<div class="#" tal:define="oddrow repeat/notary/odd;" tal:attributes="class python: oddrow and 'even' or 'odd'">
  <a href="#" tal:attributes="href python: notary.absolute_url() + '?came_from_licence_uid=' + context.UID()">
     <span tal:replace="python: context.displayValue(notary.Vocabulary('personTitle')[0], notary.getPersonTitle())" />
     <span tal:replace="notary/getName1|nothing" />
     <span tal:replace="notary/getName2|nothing" />
     <span tal:condition="notary/getSociety" tal:replace="notary/getSociety|nothing" />
  </a>
 <br />
 <span tal:content="python: notary.getStreet()+' '+notary.getNumber()" /><br />
 <span tal:content="python: notary.getZipcode()+' '+notary.getCity()" /><br />
</div>
</tal:loop>
</div>

<metal:proprietaries define-macro="urbanProprietariesMacro" i18n:domain="urban">
 <div class="#" tal:attributes="class python: test(proprietaries, 'field', 'field warning')">
 <div tal:condition="not: proprietaries" i18n:translate="warning_add_a_proprietary">
  You must encode proprietary(ies)
 </div>
 <table cellspacing=0 cellpadding=0 border=0 width=100% tal:condition="proprietaries">
 <tal:block repeat="proprietaryObj proprietaries">
  <tr class="#" tal:define="oddrow repeat/proprietaryObj/odd;" tal:attributes="class python: oddrow and 'even' or 'odd'">
   <td>
    <tal:block define="thisObject python: proprietaryObj; needExternalEdition python:False">
     <span metal:use-macro="here/urban_macros/macros/urbanActionsMacro" />
    </tal:block>
    <b>
     <span tal:replace="python: context.displayValue(proprietaryObj.Vocabulary('personTitle')[0], proprietaryObj.getPersonTitle())" />
     <span tal:replace="proprietaryObj/getName1|nothing" />
     <span tal:replace="proprietaryObj/getName2|nothing" /><br />
    </b>
    <span tal:replace="python: proprietaryObj.getStreet()+' '+proprietaryObj.getNumber()" /><br />
    <span tal:replace="python: proprietaryObj.getZipcode()+' '+proprietaryObj.getCity()" />
   </td>
  </tr>
 </tal:block>
 </table>
 <br />
 <form i18n:domain="urban" name="quickAdd" tal:attributes="action python: context.absolute_url() + '/createObject'" action="createObject" method="post" tal:define="ctype python: context.portal_types.getTypeInfo('Proprietary')">
 <img src="#" title="#" tal:attributes="src python: ctype.getIcon(); title ctype/description" i18n:attributes="title" />
 <input type="hidden" name="type_name" value="#" tal:attributes="value ctype/id" />
 <input type="submit" class="standalone" id="event" value="add_a_proprietary" i18n:attributes="value" />
 </form>
</div>
</metal:proprietaries>

<metal:applicants define-macro="urbanApplicantsMacro" i18n:domain="urban">
 <div class="#" tal:attributes="class python: applicants and 'field' or 'field warning'">
 <div tal:condition="not: applicants" i18n:translate="warning_add_an_applicant">
  You must encode applicant(s)
 </div>
 <div tal:define="tool python: context.portal_urban;
                  Batch python:modules['Products.CMFPlone'].Batch;
                  b_start request/b_start|python:0;
                  batch python: Batch(context.getApplicants(), 20, b_start);
                  showedCols python: ('Title', );
                  colsLabels python: {'Title': 'applicant_data'};
                  showActions python: True;">
  <metal:listing use-macro="here/urban_macros/macros/listing" />
 </div>
 <form tal:define="ctype python: context.portal_types.getTypeInfo('Applicant');
                   member context/@@plone_portal_state/member;"
       tal:condition="python: member.has_permission('urban: Add Contact', context)"
       tal:attributes="action python: context.absolute_url() + '/createObject'"
       i18n:domain="urban" name="quickAdd"  action="createObject" method="post">
 <img src="#" title="#" tal:attributes="src python: ctype.getIcon(); title ctype/description" i18n:attributes="title" />
 <input type="hidden" name="type_name" value="#" tal:attributes="value ctype/id" />
 <input type="submit" class="context" id="event" value="add_an_applicant" i18n:attributes="value" />
 </form>
</div>
</metal:applicants>

<div metal:define-macro="urbanEventsMacro" i18n:domain="urban" tal:define="eventTypes python:context.portal_urban.listEventTypes(context, urbanConfigId=context.portal_type.lower())">
 <table cellspacing=0 cellpadding=0 width=100%>
 <tr>
  <td>
   <form action="createUrbanEvent" method="POST"
         tal:define="member context/@@plone_portal_state/member;"
         tal:condition="python: member.has_permission('urban: Add UrbanEvent', context) and eventTypes">
    <input type='hidden' name="urban_folder_uid" tal:attributes="value here/UID" value=''>
    <select name="urban_event_type_uid">
     <tal:loopEventType repeat="eventType eventTypes">
      <option tal:attributes="value eventType/UID" value='' tal:content="eventType/Title">
      </option>
     </tal:loopEventType>
    </select>
    <input class="context" type="submit" i18n:attributes="value" value="Add an event">
   </form>
   <p class="discreet" tal:condition="not: eventTypes" i18n:translate="urban_no_eventtype_defined">No event type is defined in the configuration for this element</p>
   <br />
  </td>
 </tr>
 <tr>
  <td>
    <div tal:define="tool python: context.portal_urban;
                     batch python: tool.queryCatalog(batch=True, specificSearch='searchUrbanEvents', context=context, theObjects=False, batchlen=50);
                     showedCols python: ('Title', 'eventDate', );
                     showActions python: True;">
     <metal:listing use-macro="here/urban_macros/macros/listing" />
    </div>
  </td>
 </tr>
 </table>
</div>

<div metal:define-macro="urbanAdvicesEventsMacro" i18n:domain="urban">
 <div tal:define="allAdvices context/getAllAdvices;
                  member context/@@plone_portal_state/member;
                  mayAddUrbanEvent python: member.has_permission('urban: Add UrbanEvent', context);"
      tal:condition="python: allAdvices and mayAddUrbanEvent" >
 <fieldset><strong><legend i18n:translate="folder_advice">Folder advices</legend></strong>
  <table cellspacing=0 cellpadding=0 width=100%>
  <tr>
   <td>
    <form action="createAllAdvices" method="POST">
     <input class="context" type="submit" i18n:attributes="value" value="Add all advices">
    </form>
    <div class="discreet">
     <span i18n:translate="add_every_advices_descr">This will automatically generate following advices:</span>&nbsp;
     <span tal:content="python: ','.join([advice.Title() for advice in allAdvices])" />
    </div>
   </td>
  </tr>
  </table>
 </fieldset>
 </div>
</div>

<tal:comment replace="nothing">
Requires defined element "thisObject" as an object and
can receive a "actionsToHide" list of actions not to display</tal:comment>
<div metal:define-macro="urbanActionsMacro" i18n:domain="urban"
           tal:define="member context/@@plone_portal_state/member;
           actionsToHide actionsToHide|python:()">

  <!-- actions panel -->

  <div align="right" tal:define="wtool context/portal_workflow;
                     ext_editor context/portal_properties/site_properties/ext_editor">
      <!-- Available transitions -->
      <tal:wf_transitions condition="python: not 'transitions' in actionsToHide"
                          repeat="transition python: wtool.getTransitionsFor(thisObject)">
        <form style="display: inline;"
              tal:attributes="action python: thisObject.absolute_url() + '/content_status_modify'"
              tal:define="imageName python: transition['title'] + '.png'"
              i18n:domain="plone">
          <input type="hidden" name="workflow_action" tal:attributes="value python: transition['id']" />
          <input type="hidden" name="came_from"
                 tal:attributes="value python: context.REQUEST.get('ACTUAL_URL') + '?' + context.REQUEST.get('QUERY_STRING')" />
          <!-- Icon -->
          <input tal:condition="python: hasattr(thisObject, imageName)" type="image" tal:attributes="src string:${portal_url}/${imageName};
                                              title python: transition['id']"
                 i18n:attributes="title" />
          <!-- Button -->
          <input tal:condition="python: not hasattr(thisObject, imageName)"
                 type="submit" tal:attributes="value python: transition['id'];"
                 i18n:attributes="value"/>
        </form>
      </tal:wf_transitions>

      <!-- Edit action -->
      <tal:edit_action condition="python: member.has_permission('Modify portal content', thisObject)"
                       define="suffix python: test(needExternalEdition and ext_editor,  '/external_edit', '/edit')">
        <a class="noPadding" tal:attributes="href python: thisObject.absolute_url() + suffix">
          <img src="#" tal:attributes="src string:${portal_url}/edit.gif" title="label_edit" i18n:attributes="title" />
        </a>
      </tal:edit_action>

      <!-- Own management of the "delete" action -->
      <tal:delete_action condition="python: member.has_permission('Delete objects', thisObject)">

        <!-- will be used for overlays


    $('.urbanDelete').prepOverlay(
        {
            subtype: 'ajax',
            filter: common_content_filter,
            formselector: '#delete_confirmation',
            noform: function(el) {return $.plonepopups.noformerrorshow(el, 'redirect');},
            redirect: $.plonepopups.redirectbasehref,
            closeselector: '[name=form.button.Cancel]',
            width:'50%'
        }
        );   -->

        <a class="urbanDelete noPadding"  
           tal:attributes="href python: thisObject.absolute_url() + '/delete_confirmation'">
            <!-- Icon -->
            <img src="#" tal:attributes="src string:${portal_url}/delete_icon.gif" i18n:attributes="title" title="label_remove"
                 onClick="javascript:confirmDeleteObject(this)" style="cursor:pointer"/>
        </a>
      </tal:delete_action>
  </div>
</div>

<!-- This macro need to receive a topic -->
<!--We can receive parameters here:
boolean 'showActions' specify if we show the actions column
list 'colsLabels' specify the labels to use in the column.  If nothing is received, we use the elements from showedCols.  This attribute is usefull to rename some labels
list 'showedCols' specify a list of indexes we want to display if these indexes have been defined in the topic/customViewFields-->
<div metal:define-macro="listing" i18n:domain="plone">
<tal:topiccontents define="showActions showActions|nothing;
                           colsLabels colsLabels|nothing;
                           colsLabels python: colsLabels and colsLabels or {};
                           showedCols showedCols|topic/getCustomViewFields;
                           isALot isALot|nothing;
                           isAnEquipment isAnEquipment|nothing;">

    <tal:listing condition="batch">
    <a style='text-align: right' href="#"
        tal:condition="nocall: here/asPDF|nothing"
        tal:attributes="href string:${here_url}/asPDF/atct_topic_pdf_template/atct_topic_pdf"
        i18n:translate="label_download_as_pdf"
        i18n:domain="atcontenttypes">
        Download PDF
    </a>
    <tal:custom>

        <table class="listing"
                summary="Content listing"
                cellpadding="0" cellspacing="0" width="100%"
                i18n:attributes="summary summary_content_listing;">
                <thead i18n:domain="urban">
                <tr>
                    <tal:block repeat="field showedCols">
                     <th i18n:domain="urban" tal:content="python: 'label_colname_' + (colsLabels.has_key(field) and colsLabels[field] or field)" i18n:translate=""/>
                    </tal:block>
                    <th tal:condition="isALot" i18n:domain="urban" i18n:translate="parcels">
                      Parcels
                    </th>
                    <th tal:condition="isAnEquipment" i18n:domain="urban" i18n:translate="launchdate">
                      Launch date
                    </th>
                    <th tal:condition="showActions" i18n:domain="urban" i18n:translate="actions">
                      Actions
                    </th>
                </tr>
                </thead>
                <tbody>
                <tal:brain tal:repeat="obj batch">
                <tr tal:define="oddrow repeat/obj/odd;"
                    tal:attributes="class python:test(oddrow, 'even', 'odd')">
                    <tal:fields repeat="field showedCols"
                                define="url obj/getURL|obj/absolute_url;
                                        obj_type obj/portal_type;
                                        obj_typeinfo python: here.portal_types.getTypeInfo(obj_type);
                                        obj_icon python:plone_view.getIcon(obj);
                                        obj_wf_state obj/review_state|python: context.portal_workflow.getInfoFor(obj, 'review_state', '');
                                        member context/@@plone_portal_state/member;
                                        ploneview nocall: context/@@plone;
                                        normalizeString nocall:ploneview/normalizeString; 
                                        obj_wf_state_class python:'state-' + normalizeString(obj_wf_state);
                                        title_or_id obj/pretty_title_or_id">
                    <tal:block condition="python: field in showedCols" define="value python: getattr(obj, field, None)">
                        <td tal:condition="python: field not in ['Title', 'Creator', 'name', 'street', ]">
                            <span tal:replace="structure python: here.formatCatalogMetadata(value, long_format=False)">Field value</span>
                        </td>
                        <tal:comment replace="nothing">special case for field 'name' where we display the 'title' that is the name reworked just above</tal:comment>
                        <td tal:condition="python: field == 'name'">
                         <span tal:content="obj/getName">Name</span>
                         <br /><span tal:content="obj/Title" class="discreet">Name reworked</span>
                        </td>
                        <tal:comment replace="nothing">special case for field 'street' where we display the 'adr2' that is the 'streetname' reworked just above</tal:comment>
                        <td tal:condition="python: field == 'street'">
                         <span tal:content="obj/getStreet">Street</span>
                         <br /><span tal:content="obj/getAdr2" class="discreet">Street name reworked</span>
                        </td>
                        <td tal:condition="python: field == 'Creator'">
                         <span tal:content="python: context.portal_membership.getMemberInfo(value) and context.portal_membership.getMemberInfo(value)['fullname'] or ''">Creator fullname</span>
                        </td>
                        <td tal:condition="python: field == 'Title'">
                            <span tal:define="global url python: test(obj.portal_type == 'File' and obj.portal_properties.site_properties.ext_editor, url + '/external_edit', url)" />

                            <a href="#" tal:attributes="href url">
                                <tal:icon replace="structure obj_icon"/>
                            </a>

                            <a href="#" tal:condition="python: obj.portal_type not in ['Link', 'Image']"
                                        tal:attributes="href url;
                                                        class obj_wf_state_class"
                                        tal:content="title_or_id" />

                            <a href="#" tal:condition="python: obj.portal_type == 'Image'"
                                        tal:attributes="href string:${url}/view;
                                                        class obj_wf_state_class"
                                        tal:content="title_or_id" />

                            <a href="#"
                                tal:condition="python: obj.portal_type == 'Link'"
                                tal:attributes="href obj/getRemoteUrl;
                                                class obj_wf_state_class"
                                class="link-plain"
                                tal:content="title_or_id" />
                            <tal:block condition="python: obj.portal_type in ['UrbanEvent', 'UrbanEventInquiry',]">
                             <tal:block define="object obj/getObject;
                                                suffix python: member.has_permission('Modify portal content', object) and '/external_edit' or ''"
                                                repeat="doc object/getDocuments">
                              <br /><a href="#" class="discreet" style="margin-left:20px" tal:content="doc/Title" tal:attributes="href python: doc.absolute_url() + suffix">Document</a>
                             </tal:block>
                            </tal:block>
                            <tal:comment replace="nothing">Show more values for applicants.  This could be the case for other contacts???</tal:comment>
                            <tal:applicant condition="python: obj.meta_type == 'Contact'"
                                           define="thisObject python: hasattr(obj, 'getObject') and obj.getObject() or obj">
                             <tal:block condition="thisObject/getStreet"><br /></tal:block>
                             <span tal:replace="python: thisObject.getStreet()+' '+thisObject.getNumber()" /><br />
                             <span tal:replace="python: thisObject.getZipcode()+' '+thisObject.getCity()" />
                            </tal:applicant>
                        </td>
                    </tal:block>
                    </tal:fields>
                <td tal:condition="isALot">
                    <tal:block repeat="parcel python: obj.getObject().getParcels()">
                        <span tal:content="parcel/Title" /><br>
                    </tal:block>
                </td>
                <td tal:condition="isAnEquipment">
                    <span tal:content="python: obj.getLaunchDate()" />
                </td>
                <td tal:condition="showActions" tal:define="thisObject python: hasattr(obj, 'getObject') and obj.getObject() or obj; needExternalEdition python: test(obj.portal_type == 'File' and obj.portal_properties.site_properties.ext_editor, True, False)">
                 <div metal:use-macro="here/urban_macros/macros/urbanActionsMacro" />
                </td>
                </tr>
                </tal:brain>
                </tbody>
        </table>
    </tal:custom>

    </tal:listing>

    <p class="discreet"
        tal:condition="python: not batch"
        i18n:domain="urban"
        i18n:translate="urban_no_event_added">
        There are currently no event for this element.
    </p>

    <!-- Navigation -->
    <div metal:use-macro="here/batch_macros/macros/navigation" />

</tal:topiccontents>
</div>

<div metal:define-macro="urbanMapCSS" tal:define="pylonsHost context/portal_url/portal_urban/getPylonsHost">

        <link rel="stylesheet" type="text/css" tal:attributes="href string:ext-all.css"/>
        <link rel="stylesheet" type="text/css" tal:attributes="href string:http://${pylonsHost}/lib/ext/Ext/resources/css/xtheme-gray.css"/>

        <link rel="stylesheet" type="text/css" tal:attributes="href string:http://${pylonsHost}/lib/openlayers/theme/default/style.css"/>
        <link rel="stylesheet" type="text/css" tal:attributes="href string:http://${pylonsHost}/lib/ext/Ext/ux/grid.RowActions.css"/>
        <link rel="stylesheet" type="text/css" tal:attributes="href string:http://${pylonsHost}/app/css/main.css"/> 
</div>

<div metal:define-macro="urbanMapScript" tal:define="pylonsHost context/portal_url/portal_urban/getPylonsHost">
<script tal:content="string:var NISNum='${context/portal_url/portal_urban/getNISNum}';var urbanCapakeyArray=${view/getListCapaKey};var proxyUrl='${context/portal_url}/portal_urban/getProxy?url=';var urbanMapWMCUrl='${context/absolute_url}/wmc';">    
    </script>      
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/lib/ext/Ext/adapter/ext/ext-base.js"></script>

    
    <!--Debug mode (begin) -->
    <!--<script type="text/javascript" src="lib/openlayers/lib/OpenLayers.js"></script>-->
    <!--<script type="text/javascript" src="lib/geoext/lib/GeoExt.js"></script>-->
    <!--<script type="text/javascript" src="lib/ext/Ext/ext-all-debug.js"></script>-->
    <!--Debug mode (end) -->
    
    <!-- non debug mode (begin) -->
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/lib/ext/Ext/ext-all.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/lib/openlayers/SingleFile.js"></script>

    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/lib/geoext/script/GeoExt.js"></script>    
    <!-- non debug mode (end) -->
     
    <!-- The script below will load the configuration of the application -->
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/config/index"></script>
    <!-- The script below will load the capabilities of the print service
         and save them into the global printCapabilities variable. Instead
         of this, the PrintProvider can be configured with a url and take
         care of fetching the capabilities. --> 
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/print/info.json?var=printCapabilities"></script>
       
    <!-- debug mode (begin) -->

    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/ClickControl.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/lib/ext/Ext/ux/grid.RowActions.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/UrbanMap.PrintForm.js"></script> 
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/UrbanMap.ParcelleGrid.js"></script>     
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/UrbanMap.SearchForm.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/UrbanMap.SearchForm.Proprietaire.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/UrbanMap.SearchForm.Parcelle.js"></script>

    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/UrbanMap.ParamForm.js"></script>
    
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/GEOB_util.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/GEOB_ows.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/GEOB_managelayers.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/GEOB_FeatureDataModel.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/GEOB_resultspanel.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/GEOB_getfeatureinfo.js"></script>
    
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/UrbanMap.MapPanel.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/UrbanMap.WMSLegend.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/UrbanMap.TreePanel.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/UrbanMap.WMSCapabilitiesWindow.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/UrbanMap.UrbanLayerNode.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/UrbanMap.WMCReader.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/UrbanMap.LayerStore.js"></script>        
      
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/urban-layout.js"></script>
    <script type="text/javascript" tal:attributes="src string:http://${pylonsHost}/app/lib/App/urban-map.js"></script>   
    <!-- debug mode (end) -->
        
    <!-- non debug mode (begin) -->
    <!--
    <script type="text/javascript" src="build/app.js"></script>
   -->
    <!-- non debug mode (end) --> 
</div>

<div metal:define-macro="urbanParcelsMacro" i18n:domain='urban'>
 <table tal:define="member context/@@plone_portal_state/member;" cellspacing=0 cellpadding=0 width=100%>
  <tr>
   <td>
   <div class="#" tal:define="parcels parcels|context/getParcels" tal:attributes="class python: test(parcels, 'field', 'field warning')">
    <div tal:condition="not: parcels" i18n:translate="warning_add_a_parcel">You must encode concerned parcel(s)
    </div>
    <div tal:define="tool python: context.portal_urban;
                     batch python: tool.queryCatalog(batch=True, specificSearch='searchPortionOuts', context=context, theObjects=False, batchlen=50);                     
                     showActions python: True;
                     showedCols python: ('Title',);">
     <metal:listing use-macro="here/urban_macros/macros/listing" />
    </div>
     <form tal:condition="python: member.has_permission('urban: Add PortionOut', context)" name="quickAdd" tal:attributes="action python: context.absolute_url() + '/checkPortionsOutSearch'" action="checkPortionsOutSearch" method="post" tal:define="ctype python: context.portal_types.getTypeInfo('PortionOut')">
      <img src="#" title="#" tal:attributes="src python: ctype.getIcon(); title ctype/description" i18n:attributes="title" />
      <input type="hidden" name="type_name" value="#" tal:attributes="value ctype/id" />
      <input type="submit" class="context" id="event" value="search_parcels" i18n:attributes="value" />
     </form>
   </div>
  </td>
 </tr>
 </table>
</div>

<metal:edit define-macro="editDefaultMacro"
               tal:define="member context/@@plone_portal_state/member; 
                       border python: test(member.has_role('Manager'), 'enable_border', 'disable_border');
                       dummy python:request.set(border, 1);
                       putils context/plone_utils;">

      <tal:fieldsets repeat="fieldset python: ['default',]">
        <fieldset class="urbanEditWithTabbing" tal:define="fieldsetid python:putils.normalizeString(fieldset)"
                tal:attributes="id string:fieldset-${fieldsetid}">
          <legend id="#"
                  tal:content="python: view.getTranslatedSchemaLabel(fieldset)"
                  tal:attributes="id string:fieldsetlegend-${fieldsetid}"
                  i18n:translate="" />
          <tal:fields repeat="field python:schematas[fieldset].editableFields(here, visible_only=True)">
           <metal:fieldMacro use-macro="python:here.widget(field.getName(), mode='edit')" />
          </tal:fields>
        </fieldset>
      </tal:fieldsets>
</metal:edit>
