<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="urban">

<metal:block fill-slot="top_slot"
             tal:define="global parcels context/getParcels" />

<head>
<tal:block condition="context/getParcels">
<div metal:fill-slot="javascript_head_slot" tal:define="webserverhost python: context.portal_urban.getWebServerHost();">
    <script type="text/javascript" tal:attributes="src python:'portal_skins/openlayers/OpenLayers.js'"></script>
    <script type="text/javascript" src="mapjsglobals.js"></script>
    <script tal:content="python: 'function init() { ' + context.portal_urban.initMap(context) + '};'"></script>
</div>
</tal:block>
</head>

<body>

<div metal:fill-slot="main" onmouseover="init()">
<metal:main_macro define-macro="main">
    <metal:body define-macro="body_macro" tal:define="applicants context/getApplicants;">

<tal:block condition="python: not parcels or not applicants">
 <div metal:use-macro="here/urban_macros/macros/urbanPortalMessageMacro" />
</tal:block>

<h1 class="documentFirstHeading">
 <tal:block replace="structure python:getattr(here, here.getIcon(1))"/>
 <span tal:replace="here/Title" tal:omit-tag="">Title</span>
</h1>

<div metal:use-macro="here/urban_macros/macros/urbanFolderManagerMacro" />

 <fieldset><b><legend i18n:translate="applicants">Applicant(s)</legend></b>
  <div metal:use-macro="here/urban_macros/macros/urbanApplicantsMacro" />
 </fieldset>

 <fieldset><strong><legend i18n:translate="legend_details">Details</legend></strong>
 <table cellspacing=0 cellpadding=0 width=100%>
 <tr>
  <td width=70% valign=top>
   <u><b><span i18n:translate="urban_label_reference">Commune reference</span> :</b></u>
   <metal:myfield use-macro="python:here.widget('reference', mode='view')" />
   <br />
   <u><b><span i18n:translate="urban_label_finality">Finality</span> :</b></u>
   <metal:myfield use-macro="python:here.widget('finality', mode='view')" />
  </td>
  <td width=30%>
   <u><b><span i18n:translate="urban_label_subjects">Subjects</span> :</b></u>
   <ul>
    <li tal:repeat="subject python: context.getSubjects().split('\n')">
     <span tal:replace="subject" />
    </li>
   </ul>
  </td>
 </tr>
 </table>
 </fieldset>
 
 <fieldset><strong><legend i18n:translate="legend_operation_address">Operation address</legend></strong>
     <div metal:use-macro="here/urban_macros/macros/urbanWorkLocation" />
 </fieldset>
 
 <fieldset><strong><legend i18n:translate="concerned_parcels">Concerned parcel(s)</legend></strong>
 <table cellspacing=0 cellpadding=0 width=100%>
  <tr>
   <td>
   <div class="#" tal:attributes="class python: test(parcels, 'field', 'field warning')">
    <div tal:condition="not: parcels" i18n:translate="warning_add_a_parcel">You must encode concerned parcel(s)
    </div>
    <div tal:define="tool python: getattr(context, 'portal_urban');
                     topic python: getattr(tool.topics, 'searchportionsout');
                     path_crit python: getattr(topic, 'crit__path_ATPathCriterion');
                     dummy python: context.setPathCritValue(path_crit, context.UID());
                     showActions python: True;
                     showedCols python: ('Title', 'Creator');">
    <metal:listing use-macro="here/urban_macros/macros/listing" />
    </div>
    <p>
     <form i18n:domain="urban" name="quickAdd" tal:attributes="action python: context.absolute_url() + '/checkPortionsOutSearch'" action="checkPortionsOutSearch" method="post" tal:define="ctype python: context.portal_types.getTypeInfo('PortionOut')">
      <img src="#" title="#" tal:attributes="src python: ctype.getIcon(); title ctype/description" i18n:attributes="title" />
      <input type="hidden" name="type_name" value="#" tal:attributes="value ctype/id" />
      <input type="submit" class="standalone" id="event" value="search_parcels" i18n:attributes="value" />
     </form>
    </p>
   </div>

   <div tal:condition="not: parcels">
    <p class="discreet" i18n:translate="cartography_map_descr">A map will me displayed when you will have defined concerned parcels</p>
   </div>
   <tal:block condition="parcels">
   <form>
    <input type="hidden" id="map_initialized" value="0" />
   </form>
   <p i18n:translate="cartography" class="discreet">Cartography</p>
   <table border=0 width=100%>
       <tr>
           <td width=70%><div id="map" class="smallmap"></div></td>
           <td width=30%><iframe name="prcinfosframe" src="" width=100% height=500 scrolling=auto frameborder=0 ></iframe></td>
       </tr>
   </table>
   </tal:block>

  </td>
 </tr>
 </table>
 </fieldset>

<fieldset><strong><legend i18n:translate="folder_events">Folder events</legend></strong>
 <table cellspacing=0 cellpadding=0 width=100%>
 <tr>
  <td>
    <div tal:define="tool python: getattr(context, 'portal_urban');
                     topic python: getattr(tool.topics, 'searchurbanevents');
                     path_crit python: getattr(topic, 'crit__path_ATPathCriterion');
                     dummy python: context.setPathCritValue(path_crit, context.UID());
                     showActions python: True;">
    <metal:listing use-macro="here/urban_macros/macros/listing" />
    </div>
  </td>
 </tr>
 <tr>
  <td>
   <metal:events use-macro="here/urban_macros/macros/urbanEventsMacro" />
  </td>
 </tr>
 </table>
</fieldset>

<!-- Begin PloneTask integration -->
<tal:block condition="python: tasks and context.portal_quickinstaller.isProductInstalled('PloneTask') and context.portal_urban.getUsePloneTask()"
           define="tool python: getattr(context, 'portal_urban');
                   topic python: getattr(tool.topics, 'searchurbanevents');
                   path_crit python: getattr(topic, 'crit__path_ATPathCriterion');
                   dummy python: context.setPathCritValue(path_crit, context.UID());
                   tasks topic/queryCatalog;">
<!-- <div metal:use-macro="here/task_macros/macros/tasksList" /> -->
<div tal:content="structure python: context.portal_plonetask.getGanttChart(tasks)" />
<fieldset><strong><legend i18n:translate="legend">Legend</legend></strong>
<span style="color: green;" i18n:translate="tasks_in_progress">Tasks in progress</span><br />
<span style="color: orange;" i18n:translate="to_watch_tasks">Tasks to watch (75% of the given delay is exceeded)</span><br />
<span style="color: red;" i18n:translate="late_tasks">Late tasks</span><br />
<span style="color: grey;" i18n:translate="closed_tasks">Closed tasks</span>
</fieldset>
</tal:block>
<!-- End PloneTask integration -->

<div tal:replace="structure provider:plone.belowcontentbody" />

</metal:body>
</metal:main_macro>
</div>
</body>
</html>
