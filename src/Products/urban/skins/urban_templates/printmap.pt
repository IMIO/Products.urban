<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr"
      lang="fr"
      i18n:domain="urban">
    <head>
        <title>Print map</title>
            <link rel="stylesheet" tal:attributes="href python:'portal_skins/openlayers/theme/default/style.css'" type="text/css" />
        <style>
          @media print
          {
            #print_btn { display: none; }
            #scale_ctn { display: none; }
          }
        </style>
        <script type="text/javascript" tal:attributes="src python:'portal_skins/openlayers/OpenLayers.js'"></script>
    <script type="text/javascript">
         var map;
            function gup( name )
            {
              name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
              var regexS = "[\\?&]"+name+"=([^&#]*)";
              var regex = new RegExp( regexS );
              var results = regex.exec( window.location.href );
              if( results == null )
                return "";
              else
                return results[1];
            }
        function init(){
            
            //Template parameter

            //HTML way to get parameters
            var extentString = gup('extent');
            var cql_filter = unescape(gup('cql'));          
            var layers = gup('layers');
            
            
            var format = 'image/png';
            var extent = extentString.split(',');
            var bounds = new OpenLayers.Bounds(extent[0],extent[1],extent[2],extent[3]);

            var options = {
                controls: [],
                maxExtent: bounds,
                maxResolution: 42.71197656250001,
                projection: "EPSG:31370",
                units: 'm'
            };
                    map = new OpenLayers.Map('map', options);

                var wmsLayer = new OpenLayers.Layer.WMS(
                    "fond de plan", "http://localhost:8080/geoserver/ows",
                    {
                        layers: layers,
                        srs: 'EPSG:31370',
                        format: format
                    },
                    {singleTile: true } 
                );
                map.addLayers([wmsLayer]);
            if(cql_filter != "")
            {
                var selection = new OpenLayers.Layer.WMS(
                    "selection", "http://localhost:8080/geoserver/wms",
                    {
                        layers: 'urban92141:capa',
                        styles: 'Selection',
                        srs: 'EPSG:31370',
                        format: format,
                        transparent: true,
                        cql_filter: cql_filter
                    },
                    {singleTile: true, ratio: 1,'isBaseLayer': false} 
                );
                map.addLayers([selection]);
            }

            map.zoomToExtent(bounds);
        }
        function changeScale(newScale)
        {
            if(map.zoomToScale)
            {
                map.zoomToScale(newScale);
            }
        }
        </script>
    </head>
    <body onload="init()">
    <!--  <p tal:replace="structure python:request.QUERY_STRING"></p>-->
    
        <h1>Map</h1>
        <div id="scale_ctn">
        <h3>Echelle :</h3>
        <ul id="scale_list">
            <li><a href="#" onClick="changeScale(10000);return false;">1/10.000</a></li>
            <li><a href="#" onClick="changeScale(5000);return false;">1/5000</a></li>
            <li><a href="#" onClick="changeScale(1000);return false;">1/1000</a></li>
            <li><a href="#" onClick="changeScale(500);return false;">1/500</a></li>
        </ul>
        </div>
        <div id="map" style="width:800px;height:600px;border: 1px solid black;">
        </div>
        <button id="print_btn" onclick="print();">Imprimer</button>
    <body>
</html>
