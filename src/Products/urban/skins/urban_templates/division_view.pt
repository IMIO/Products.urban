<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="urban">

<metal:block fill-slot="top_slot"
             tal:define="global parcels context/getParcels" />

<head>
<tal:block condition="context/getParcels">
<div metal:fill-slot="javascript_head_slot" tal:define="webserverhost python: context.portal_urban.getWebServerHost();">
    <script type="text/javascript" tal:attributes="src python:'portal_skins/openlayers/OpenLayers.js'"></script>
    <script type="text/javascript" src="mapjsglobals.js"></script>
    <script tal:content="python: 'function init() { ' + context.portal_urban.initMap(context) + '};'"></script>
</div>
</tal:block>
</head>

<body>

<div metal:fill-slot="main" onmouseover="init()">
<metal:main_macro define-macro="main">
    <metal:body define-macro="body_macro" tal:define="proprietaries context/getProprietaries;">

<tal:block condition="python: not parcels or not proprietaries">
 <div metal:use-macro="here/urban_macros/macros/urbanPortalMessageMacro" />
</tal:block>

<h1 class="documentFirstHeading">
 <tal:block replace="structure python:getattr(here, here.getIcon(1))"/>
 <span tal:replace="here/Title" tal:omit-tag="">Title</span>
</h1>

<fieldset><legend><strong tal:content="context/getDivisionSubject">Subject</strong></legend>
<span class="discreet" tal:content="structure context/getComments">Comments</span>
</fieldset>

<div metal:use-macro="here/urban_macros/macros/urbanFolderManagerMacro" />

<table cellspacing=0 cellpadding=0 width=100%>
 <tr>
  <td valign="top">
   <fieldset><b><legend i18n:translate="proprietaries">Proprietary(ies)</legend></b>
    <table width=400>
        <tr>
            <td>
                <div metal:use-macro="here/urban_macros/macros/urbanProprietariesMacro" />
            </td>
        </tr>
    </table>
   </fieldset>
  </td>
 </tr>
 <tr>
  <td colspan=2>
     <fieldset><strong><legend i18n:translate="legend_details">Details</legend></strong>
      <u><b><span i18n:translate="urban_label_reference">Commune reference</span> :</b></u>
       <metal:myfield use-macro="python:here.widget('reference', mode='view')" />
     </fieldset>
  </td>
 </tr>
 <tr>
  <td colspan=2>
     <fieldset><strong><legend i18n:translate="legend_situation">Situation</legend></strong>
      <table cellspacing=0 cellpadding=0 width=100%>
       <tr>
        <td colspan=2>
           <div metal:use-macro="here/urban_macros/macros/urbanWorkLocation" />
        </td>
       </tr>
      </table>
     </fieldset>
  </td>
 </tr>
 </table>
 
 <fieldset><strong><legend i18n:translate="concerned_parcels">Concerned parcel(s)</legend></strong>
 <table cellspacing=0 cellpadding=0 width=100%>
  <tr>
   <td>
   <div class="#" tal:attributes="class python: test(parcels, 'field', 'field warning')">
    <div tal:condition="not: parcels" i18n:translate="warning_add_a_parcel">You must encode concerned parcel(s)
    </div>
    <div tal:define="tool python: getattr(context, 'portal_urban');
                     topic python: getattr(tool.topics, 'searchportionsout');
                     path_crit python: getattr(topic, 'crit__path_ATPathCriterion');
                     dummy python: context.setPathCritValue(path_crit, context.UID());
                     showActions python: True;
                     showedCols python: ('Title', 'Creator');">
    <metal:listing use-macro="here/urban_macros/macros/listing" />
    </div>
    <p>
     <form i18n:domain="urban" name="quickAdd" tal:attributes="action python: context.absolute_url() + '/checkPortionsOutSearch'" action="checkPortionsOutSearch" method="post" tal:define="ctype python: context.portal_types.getTypeInfo('PortionOut')">
      <img src="#" title="#" tal:attributes="src python: ctype.getIcon(); title ctype/description" i18n:attributes="title" />
      <input type="hidden" name="type_name" value="#" tal:attributes="value ctype/id" />
      <input type="submit" class="standalone" id="event" value="search_parcels" i18n:attributes="value" />
     </form>
    </p>
   </div>

   <div tal:condition="not: parcels">
    <p class="discreet" i18n:translate="cartography_map_descr">A map will me displayed when you will have defined concerned parcels</p>
   </div>
   <tal:block condition="parcels">
   <form>
    <input type="hidden" id="map_initialized" value="0" />
   </form>
   <p i18n:translate="cartography" class="discreet">Cartography</p>
   <table border=0 width=100%>
       <tr>
           <td width=70%><div id="map" class="smallmap"></div></td>
           <td width=30%><iframe name="prcinfosframe" src="" width=100% height=500 scrolling=auto frameborder=0 ></iframe></td>
       </tr>
   </table>
   </tal:block>

  </td>
 </tr>
 </table>
 </fieldset>
<br /><b><u><span i18n:translate="urban_label_folderZone">Folder zone</span> :</u></b>
   <br /><metal:myfield use-macro="python:here.widget('folderZone', mode='view')" />
   
<fieldset><strong><legend i18n:translate="folder_events">Folder events</legend></strong>
 <table cellspacing=0 cellpadding=0 width=100%>
 <tr>
  <td>
    <div tal:define="tool python: getattr(context, 'portal_urban');
                     topic python: getattr(tool.topics, 'searchurbanevents');
                     path_crit python: getattr(topic, 'crit__path_ATPathCriterion');
                     dummy python: context.setPathCritValue(path_crit, context.UID());
                     showActions python: True;">
    <metal:listing use-macro="here/urban_macros/macros/listing" />
    </div>
  </td>
 </tr>
 <tr>
  <td>
   <metal:events use-macro="here/urban_macros/macros/urbanEventsMacro" /> 
  </td>
 </tr>
 </table>
</fieldset>

<div tal:replace="structure provider:plone.belowcontentbody" />

</metal:body>
</metal:main_macro>
</div>
</body>
</html>
