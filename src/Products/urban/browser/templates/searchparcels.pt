<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xml:lang="en" lang="en"
      i18n:domain="urban"
      metal:use-macro="here/main_template/macros/master">


<metal:block fill-slot="top_slot"
             tal:define="dummy python:request.set('disable_border',1)" />

<body>
<div metal:fill-slot="main">
<!-- dÃ©finition des variables -->
<div tal:define="division request/division | nothing;
                 section request/section | nothing;
                 radical request/radical | nothing;
                 bis request/bis | nothing;
                 exposant request/exposant | nothing;
                 puissance request/puissance | nothing;
                 partie request/partie | nothing;
                 location request/location | nothing;
                 prcOwner request/prcOwner | nothing;
                 prcHistory request/prcHistory | nothing;
                 browseOldParcels request/browseOldParcels | nothing;
                 divisions view/getDivisions;
                 prca request/prca | nothing;
                 divname request/divname | nothing;">

<h1 class="documentFirstHeading" i18n:translate="search_parcels"></h1>

<tal:comment replace="nothing">Go back...</tal:comment>
<metal:listing use-macro="here/urban_macros/macros/goBackToMacro" />

<!-- Display the list of already added parcels -->
<fieldset><legend i18n:translate="concerned_parcels">Concerned parcels</legend>
<div style="width: 800px" tal:define="tool python: context.portal_urban;
                 batch python: tool.queryCatalog(batch=True, specificSearch='searchPortionOuts', context=context, theObjects=False, batchlen=50);
                 showActions python: True;
                 showedCols python: ('Title',);">
 <metal:listing use-macro="here/urban_macros/macros/listing" />
</div>
</fieldset>

<fieldset><legend i18n:translate="">Search parcel(s)</legend>
<p tal:condition="not: divisions" i18n:translate="help_search_connection_problem">
 You can not search for parcels for now because there was a problem.  Please contact your system administrator and give him the red error message here above
</p>
<tal:searchIsEnabled condition="divisions">
<p class="discreet" i18n:translate="help_search_parcels">Choose one of the following forms to search for parcels.  You can cumulate criteria if you exactly know what you are looking for</p>
<p>&nbsp;</p>
<form action="" method="GET">
<table class="listing" width=800>
 <thead>
  <tr>
   <th colspan="7"><strong i18n:translate="urban_search_parcel_by_cadastral_reference">Cadastral reference</strong></th>
  </tr>
 </thead>
 <tbody>
  <tr align=center>
   <td>
    <label class="discreet" i18n:translate="urban_label_division">Division</label><br />
    <select name="division" value="division">
     <tal:block condition="python: not ('Programming error in query','Programming error in query') in divisions" repeat="div divisions">
      <option tal:attributes="selected python: str(div['da']) == division; value python: div['da'];" tal:content="python: div['divname']" />
     </tal:block>
    </select>
   </td>
   <td>
    <label class="discreet" i18n:translate="urban_label_section">Section</label><br />
    <input style="text-transform: uppercase" size="5" maxlength="1" type="text" name="section" tal:attributes="value section">
   </td>
   <td>
    <label class="discreet" i18n:translate="urban_label_radical">Radical</label><br />
    <input size="5" maxlength="4" type="text" name="radical" tal:attributes="value radical">
   </td>
   <td>
    <label class="discreet" i18n:translate="urban_label_bis">Bis</label><br />
    / <input size="4" maxlength="2" type="text" name="bis" tal:attributes="value bis">
   </td>
   <td>
    <label class="discreet" i18n:translate="urban_label_exposant">Exposant</label><br />
    <input style="text-transform: uppercase" size="5" maxlength="1" type="text" name="exposant" tal:attributes="value exposant">
   </td>
   <td>
    <label class="discreet" i18n:translate="urban_label_puissance">Puissance</label><br />
    <input size="5" type="text" name="puissance" maxlength="2" tal:attributes="value puissance">
   </td>
   <td>
    <label class="discreet" i18n:translate="urban_label_partie">Partie</label><br />
    <input type="checkbox" name="partie" tal:attributes="value partie">
   </td>
  </tr>
 </tbody>
</table>

<table style="margin-bottom: 0em;">
 <tr>
  <td width="390px" valign="top">
      <table width=100% class="listing">
       <thead>
        <tr>
         <th>
          <strong i18n:translate="urban_search_parcel_by_location">Location</strong>
         </th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td>
          <input type="text" id="location" name="location" tal:attributes="value location; disabled python: request.get('browseOldParcels') and 'disabled' or ''" /></td>
        </tr>
       </tbody>
      </table>
   </td>
   <td width="20px"></td>
   <td width="390px" valign="top">
      <table width=100% class="listing">
       <thead>
        <tr>
         <th>
          <strong i18n:translate="urban_search_parcel_by_proprietary">Proprietary</strong>
         </th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td>
          <input type="text" id="prcOwner" name="prcOwner" tal:attributes="value prcOwner; disabled python: request.get('browseOldParcels') and 'disabled' or ''" />
         </td>
        </tr>
       </tbody>
      </table>
   </td>
 </tr>
 <tr>
   <td colspan=3>
     <input onclick="var adress = document.getElementById('location');
                     var owner = document.getElementById('prcOwner');
                     var browseOldParcels = document.getElementById('browseOldParcels');
                     var oldParcels = (browseOldParcels.getAttribute('checked') != 'checked');
                     if (oldParcels) {
                        owner.setAttribute('disabled', 'disabled');
                        adress.setAttribute('disabled', 'disabled');
                        browseOldParcels.setAttribute('checked', 'checked');
                     }
                     else {
                        adress.removeAttribute('disabled');
                        owner.removeAttribute('disabled');
                        browseOldParcels.setAttribute('checked', '');
                     }"
           type="checkbox" id="browseOldParcels" name="browseOldParcels" value="1" checked="bla" tal:attributes="checked python: request.get('browseOldParcels') and 'checked' or ''"/>
     <label i18n:domain="plone" i18n:translate="">Browse old parcels (Only works with the parcel reference)</label>
   <td>
 </tr>
</table><br/>
<input class="searchButton" type="submit" value="Search" i18n:attributes="value" />
</form>

<!-- Display results -->
<tal:block define="results python:view.findParcel(division=division,section=section,radical=radical,bis=bis,exposant=exposant,puissance=puissance,location=location,prcOwner=prcOwner,prcHistory=prcHistory, browseOldParcels=browseOldParcels);
                   oldparcels request/prcHistory | nothing"
           condition="python: results or oldparcels">
<br />
<table class="listing" class="listing" width="100%" border="0" cellspacing="0">
 <thead>
  <tr>
   <th colspan="2" i18n:translate="">
    Found parcel(s)
   </th>
  </tr>
 </thead>
 <!-- Display 'no results' -->
 <tal:block condition="not: python:results or prcOwner or location">
 <tal:def define="resultsOldPrc python: view.findOldParcel(division=division,section=section,radical=radical,bis=bis,exposant=exposant,puissance=puissance,prcHistory=prcHistory,divname=divname,prca=prca)">
  <tr tal:condition="not: resultsOldPrc">
   <td colspan=2 i18n:domain="atcontenttypes" i18n:translate="description_no_items_in_topic" class="discreet">No result found.</td>
  </tr>
  <tr tal:repeat="resold resultsOldPrc">
   <tal:block define="oddrow repeat/resold/odd;" tal:attributes="class python: oddrow and 'even' or 'odd'">
   <td fcolor="#FF0000">
    <span tal:replace="structure python: '&nbsp;'*resold['level']*3" tal:condition="python: resold.has_key('level') and resold['level']"/>
    <span tal:content="python: resold['divname']"/>
    <span tal:content="python: str(resold['prca'])"></span>
    <span i18n:translate="" tal:condition="python: not resold.has_key('level') or resold['level']">(Attention!! ancien nom de parcelle)</span>
   </td>
   </tal:block>
   <td>
    <form i18n:domain="urban" name="quickAddParcel" tal:attributes="action python: context.absolute_url() + '/addPortionOutScript'" action="#" method="post">
     <input type="hidden" name="division" value="#" tal:attributes="value python: resold['da']" />
     <input type="hidden" name="section" value="#" tal:attributes="value python: resold['sectionavant']" />
     <input type="hidden" name="radical" value="#" tal:attributes="value python: resold['radicalavant']" />
     <input type="hidden" name="bis" value="#" tal:attributes="value python: resold['bisavant']" />
     <input type="hidden" name="exposant" value="#" tal:attributes="value python: resold['exposantavant']" />
     <input type="hidden" name="puissance" value="#" tal:attributes="value python: resold['puissanceavant']" />
     <input type="hidden" name="partie" value="#" tal:attributes="value partie" />
     <input type="submit" class="context" id="parcel" value="Add this parcel" i18n:attributes="value" />
    </form>
   </td>
  </tr>
 </tal:def>
 </tal:block>
 <!-- Display the results body -->
 <tal:block tal:repeat="res results" tal:condition="python:results">
  <tr>
   <td>
    <span tal:content="python: res['divname']"/>
    <span tal:content="python: res['prc']"/>
    <span i18n:translate="" tal:condition="python: res.has_key('old') and res['old']">(Attention!! ancien nom de parcelle)</span><br>
    <span tal:condition="python: res.has_key('sl1')" tal:content="python: res['sl1']"/><br>
    <span tal:condition="python: res.has_key('pe')" tal:content="python: res['pe']"/><br>
   </td>
   <td>
    <form i18n:domain="urban" name="quickAddParcel" tal:attributes="action python: context.absolute_url() + '/addPortionOutScript'" action="#" method="post">
      <input type="hidden" name="division" value="#" tal:attributes="value python: res['da']" />
      <input type="hidden" name="section" value="#" tal:attributes="value python: res['section']" />
      <input type="hidden" name="radical" value="#" tal:attributes="value python: res['radical']" />
      <input type="hidden" name="bis" value="#" tal:attributes="value python: res['bis']" />
      <input type="hidden" name="exposant" value="#" tal:attributes="value python: res['exposant']" />
      <input type="hidden" name="puissance" value="#" tal:attributes="value python: res['puissance']" />
      <input type="hidden" name="partie" value="#" tal:attributes="value partie" />
      <input type="submit" class="context" id="parcel" value="Add this parcel" i18n:attributes="value" />
    </form>

    <form i18n:domain="urban" name="findPrcHistory" tal:attributes="action python: context.absolute_url() + '/searchparcels'" action="#" method="post">
      <input type="hidden" name="division" value="#" tal:attributes="value python: res['da']" />
      <input type="hidden" name="section" value="#" tal:attributes="value python: res['section']" />
      <input type="hidden" name="radical" value="#" tal:attributes="value python: res['radical']" />
      <input type="hidden" name="bis" value="#" tal:attributes="value python: res['bis']" />
      <input type="hidden" name="exposant" value="#" tal:attributes="value python: res['exposant']" />
      <input type="hidden" name="puissance" value="#" tal:attributes="value python: res['puissance']" />
      <input type="hidden" name="partie" value="#" tal:attributes="value partie" />
      <input type="hidden" name="prcHistory" value="1"/>
      <input type="hidden" name="divname" value="#" tal:attributes="value python: res['divname']" />
      <input type="hidden" name="prca" value="#" tal:attributes="value python: res['prc']" />
      <input type="submit" class="searchButton" id="parcel" value="Rechercher les anciens noms" i18n:attributes="value" />
    </form>
   </td>
  </tr>
 </tal:block>
</table>
</tal:block>
</tal:searchIsEnabled>
</fieldset>

</div>
</div>
</body>
</html>
