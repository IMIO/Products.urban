<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xml:lang="en" lang="en"
      i18n:domain="urban"
      metal:use-macro="here/main_template/macros/master">


    <metal:block fill-slot="top_slot"
                 tal:define="dummy python:request.set('disable_border',1)" />

    <body>
        <div metal:fill-slot="main">
        <!-- dÃ©finition des variables -->
            <div tal:define="division request/division | nothing;
                             section python: request.get('section', '').upper();
                             radical python: request.get('radical', '').upper();
                             bis python: request.get('bis', '').upper();
                             exposant python: request.get('exposant', '').upper();
                             puissance python: request.get('puissance', '').upper();
                             partie request/partie | nothing;
                             location request/location | nothing;
                             parcel_owner request/parcel_owner | nothing;
                             parcel_history request/parcel_history | nothing;
                             browse_old_parcels request/browse_old_parcels | nothing;
                             divisions view/divisions;
                             prca request/prca | nothing;
                             divname request/divname | nothing;">

            <h1 class="documentFirstHeading" i18n:translate="search_parcels"></h1>

            <tal:comment replace="nothing">Go back...</tal:comment>
            <metal:listing use-macro="here/@@globalmacros/goBackToMacro" />

                <!-- Display the list of already added parcels -->
                <fieldset><legend i18n:translate="concerned_parcels">Concerned parcels</legend>
                    <div style="width: 800px">
                        <tal:listing content="structure view/renderParcelsListing" />
                    </div>
                </fieldset>

                <fieldset><legend i18n:translate="">Search parcel(s)</legend>
                    <p tal:condition="not: divisions" i18n:translate="help_search_connection_problem">
                         You can not search for parcels for now because there was a problem.
                         Please contact your system administrator and give him the red error message here above
                    </p>
                    <tal:searchIsEnabled condition="divisions">
                        <p class="discreet" i18n:translate="help_search_parcels">
                            Choose one of the following forms to search for parcels.
                            You can cumulate criteria if you exactly know what you are looking for
                        </p>
                        <p>&nbsp;</p>
                        <form action="" method="GET">
                            <table class="listing" width=800>
                                 <thead>
                                     <tr>
                                         <th colspan="7"><strong i18n:translate="urban_search_parcel_by_cadastral_reference">Cadastral reference</strong></th>
                                     </tr>
                                 </thead>
                                 <tbody>
                                     <tr align=center>
                                         <td>
                                             <label class="discreet" i18n:translate="urban_label_division">Division</label><br />
                                             <select name="division" value="division">
                                                 <tal:block condition="python: type(divisions) is list"
                                                            repeat="div divisions">
                                                     <option tal:attributes="selected python: str(div[0]) == division; value python: div[0];"
                                                             tal:content="python: div[1]" />
                                                 </tal:block>
                                             </select>
                                         </td>
                                         <td>
                                             <label class="discreet" i18n:translate="urban_label_section">Section</label><br />
                                                 <input style="text-transform: uppercase" size="5" maxlength="1" type="text" name="section"
                                                        tal:attributes="value section">
                                         </td>
                                         <td>
                                             <label class="discreet" i18n:translate="urban_label_radical">Radical</label><br />
                                             <input size="5" maxlength="4" type="text" name="radical" tal:attributes="value radical">
                                         </td>
                                         <td>
                                             <label class="discreet" i18n:translate="urban_label_bis">Bis</label><br />
                                           / <input size="4" maxlength="2" type="text" name="bis" tal:attributes="value bis">
                                         </td>
                                         <td>
                                             <label class="discreet" i18n:translate="urban_label_exposant">Exposant</label><br />
                                             <input style="text-transform: uppercase" size="5" maxlength="1" type="text" name="exposant" tal:attributes="value exposant">
                                         </td>
                                         <td>
                                             <label class="discreet" i18n:translate="urban_label_puissance">Puissance</label><br />
                                             <input size="5" type="text" name="puissance" maxlength="2" tal:attributes="value puissance">
                                         </td>
                                         <td>
                                             <label class="discreet" i18n:translate="urban_label_partie">Partie</label><br />
                                             <input type="checkbox" name="partie" tal:attributes="value partie">
                                         </td>
                                     </tr>
                                 </tbody>
                             </table>

                             <table style="margin-bottom: 0em;">
                                 <tr>
                                     <td width="390px" valign="top">
                                         <table width=100% class="listing">
                                             <thead>
                                                 <tr>
                                                     <th>
                                                         <strong i18n:translate="urban_search_parcel_by_location">Location</strong>
                                                     </th>
                                                 </tr>
                                             </thead>
                                             <tbody>
                                                 <tr>
                                                     <td>
                                                         <input type="text" id="location" name="location"
                                                                tal:attributes="value location; disabled python: request.get('browse_old_parcels') and 'disabled' or ''" />
                                                     </td>
                                                 </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                    <td width="20px"></td>
                                    <td width="390px" valign="top">
                                        <table width=100% class="listing">
                                            <thead>
                                                <tr>
                                                    <th>
                                                        <strong i18n:translate="urban_search_parcel_by_proprietary">Proprietary</strong>
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>
                                                        <input type="text" id="parcel_owner" name="parcel_owner"
                                                                tal:attributes="value parcel_owner; disabled python: request.get('browse_old_parcels') and 'disabled' or ''" />
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan=3>
                                        <input onclick="var adress = document.getElementById('location');
                                                        var owner = document.getElementById('parcel_owner');
                                                        var browse_old_parcels = document.getElementById('browse_old_parcels');
                                                        var oldParcels = (browse_old_parcels.getAttribute('checked') != 'checked');
                                                        if (oldParcels) {
                                                            owner.setAttribute('disabled', 'disabled');
                                                            adress.setAttribute('disabled', 'disabled');
                                                            browse_old_parcels.setAttribute('checked', 'checked');
                                                         }
                                                         else {
                                                            adress.removeAttribute('disabled');
                                                            owner.removeAttribute('disabled');
                                                            browse_old_parcels.setAttribute('checked', '');
                                                         }"
                                               type="checkbox" id="browse_old_parcels" name="browse_old_parcels" value="1" checked="bla"
                                               tal:attributes="checked python: request.get('browse_old_parcels') and 'checked' or ''"/>
                                        <label i18n:translate="urban_browse_old_parcels">Browse old parcels (Only works with the parcel reference)</label>
                                    <td>
                                </tr>
                            </table><br/>
                            <input class="context" type="submit" value="Search" i18n:attributes="value" />
                        </form>

                        <!-- Display results -->
                        <tal:block define="results view/search_parcels;
                                                   oldparcels request/parcel_history | nothing"
                                   condition="python: results or oldparcels">
                            <br />
                            <table class="listing" class="listing" width="100%" border="0" cellspacing="0"
                                   tal:condition="python: results">
                                <thead>
                                    <tr>
                                        <th colspan=2 i18n:translate="">
                                            Found parcel(s)
                                        </th>
                                    </tr>
                                </thead>
                                <!-- Display the results body -->
                                <tal:block tal:repeat="res results">
                                    <tr>
                                        <td>
                                            <span tal:content="python: res.display()"/>
                                            <span i18n:translate="" tal:condition="python: getattr(res, 'old', False)">(Attention!! ancien nom de parcelle)</span><br>
                                            <span tal:condition="python: hasattr(res, 'location')" tal:content="python: res.location"/><br>
                                            <span tal:condition="python: hasattr(res, 'proprietary')" tal:content="python: res.proprietary"/><br>
                                        </td>
                                        <td>
                                            <form i18n:domain="urban" name="quickAddParcel" action="#" method="post"
                                                  tal:attributes="action string: ${context/absolute_url}/searchparcels">
                                                <tal:create_owner condition="python: view.contextIsLicence() and hasattr(res, 'proprietary')">
                                                    <input type="checkbox" name="proprietary" value="#" tal:attributes="value python: res.proprietary"/>
                                                    <input type="hidden" name="proprietary_city" value="#" tal:attributes="value python: res.proprietary_city" />
                                                    <input type="hidden" name="proprietary_street" value="#"
                                                           tal:attributes="value python: res.proprietary_street" />
                                                    <span i18n:translate=""> Create proprietary/applicant</span><br />
                                                </tal:create_owner>
                                                <input type="hidden" name="division" value="#" tal:attributes="value python: res.division" />
                                                <input type="hidden" name="section" value="#" tal:attributes="value python: res.section" />
                                                <input type="hidden" name="radical" value="#" tal:attributes="value python: res.radical" />
                                                <input type="hidden" name="bis" value="#" tal:attributes="value python: res.bis" />
                                                <input type="hidden" name="exposant" value="#" tal:attributes="value python: res.exposant" />
                                                <input type="hidden" name="puissance" value="#" tal:attributes="value python: res.puissance" />
                                                <input type="hidden" name="partie" value="#" tal:attributes="value partie" />
                                                <input type="hidden" name="old" value="#" tal:attributes="value python: getattr(res, 'old', False)"/>
                                                <input type="hidden" name="location" value="#" tal:attributes="value python: getattr(res, 'location', '')" />
                                                <input type="submit" name="add_parcel" class="context" id="parcel" value="Add this parcel" i18n:attributes="value" />
                                            </form>

                                            <form i18n:domain="urban" name="findPrcHistory"
                                                  tal:attributes="action string:${context/absolute_url}/searchparcels" action="#" method="post">
                                                <input type="hidden" name="division" value="#" tal:attributes="value python: res.division" />
                                                <input type="hidden" name="section" value="#" tal:attributes="value python: res.section" />
                                                <input type="hidden" name="radical" value="#" tal:attributes="value python: res.radical" />
                                                <input type="hidden" name="bis" value="#" tal:attributes="value python: res.bis" />
                                                <input type="hidden" name="exposant" value="#" tal:attributes="value python: res.exposant" />
                                                <input type="hidden" name="puissance" value="#" tal:attributes="value python: res.puissance" />
                                                <input type="hidden" name="partie" value="#" tal:attributes="value partie" />
                                                <input type="hidden" name="parcel_history" value="1"/>
                                                <input type="hidden" name="divname" value="#" tal:attributes="value python: res.divname" />
                                                <input type="hidden" name="old" value="#" tal:attributes="value python: getattr(res, 'old', False)"/>
                                                <input type="submit" class="context" id="parcel" value="Rechercher les autres noms" i18n:attributes="value" />
                                           </form>
                                       </td>
                                   </tr>
                               </tal:block>
                            </table>
                       </tal:block>
                        <tal:block define="oldparcels request/parcel_history | nothing"
                                   condition="python: oldparcels">
                            <table class="listing" class="listing" border="0" cellspacing="0"
                                   tal:define="historic view/search_historic_of_parcel">
                                <thead>
                                    <tr>
                                        <th i18n:translate="" tal:attributes="colspan python: historic.width">
                                            Found parcel(s)
                                        </th>
                                    </tr>
                                </thead>
                                    <tr tal:repeat="line_result historic/table_display" style='text-align: center;'>
                                        <!--tal:block define="oddrow repeat/resold/odd;" tal:attributes="class python: oddrow and 'even' or 'odd'"-->
                                        <tal:line repeat="resold line_result">
                                            <td fcolor="#FF0000"
                                                tal:attributes="style python: getattr(resold, 'level', None) == 0 and 'color:green' or '';
                                                                colspan python: resold.width">
                                                <span tal:content="resold/display"></span>
                                                <!--span i18n:translate="" tal:condition="python: resold.old">(Attention!! ancien nom de parcelle)</span-->
                                            </td>
                                        <!--/tal:block-->
                                        </tal:line>
                                        <!--td>
                                            <form i18n:domain="urban" name="quickAddParcel"
                                                  tal:attributes="action string: ${context/absolute_url}/searchparcels" action="#" method="post">
                                                <input type="hidden" name="division" value="#" tal:attributes="value python: resold.division" />
                                                <input type="hidden" name="section" value="#" tal:attributes="value python: resold.section" />
                                                <input type="hidden" name="radical" value="#" tal:attributes="value python: resold.radical" />
                                                <input type="hidden" name="bis" value="#" tal:attributes="value python: resold.bis" />
                                                <input type="hidden" name="exposant" value="#" tal:attributes="value python: resold.exposant" />
                                                <input type="hidden" name="puissance" value="#" tal:attributes="value python: resold.puissance" />
                                                <input type="hidden" name="partie" value="#" tal:attributes="value partie" />
                                                <input type="hidden" name="old" value="#"
                                                       tal:attributes="value python: resold.get('old', False) or resold.get('level', False)"/>
                                                <input type="submit" name="add_parcel" class="context" id="parcel" value="Add this parcel" i18n:attributes="value" />
                                            </form>
                                        </td-->
                                    </tr>
                            </table>
                       </tal:block>
                   </tal:searchIsEnabled>
               </fieldset>

           </div>
       </div>
   </body>
</html>
