<div metal:define-macro="description_macro" i18n:domain="urban">
    <table cellspacing=0 cellpadding=0 width=100%>
        <tr>
            <td metal:define-slot="applicant_slot" valign="top" width=49%>
                <fieldset><legend i18n:translate="applicants">Applicant(s)</legend>
                    <div metal:use-macro="here/@@licencemacros/urbanApplicantsMacro" />
                </fieldset>
            </td>
            <td width="1%"></td>
            <td metal:define-slot="keydates_slot" valign="top" width=50%>
                <fieldset><legend i18n:translate="urban_description_key_dates_legend">Key dates</legend>
                    <table tal:define="keyDates view/getKeyDates;
                                       inquiryDates view/getInquiryDates"
                           class="no-style-table" cellspacing=0 cellpadding=0 width=100%>
                        <tr tal:repeat="date keyDates">
                            <td valign="top"><b><span tal:content="python: date['label']">Receipt date</span>:</b></td>
                            <td width="2%"></td>
                            <td valign="top" tal:define="date_value python: date['date']">
                                <a href="#" tal:condition="date_value" tal:attributes="href python: date['url']" tal:content="python: date_value">Content</a>
                                <span class="discreet" tal:condition="not: date_value" i18n:translate="content_none">None</span>
                            </td>
                        </tr>
                        <tal:inquiries repeat="inquiry inquiryDates">
                        <tr>
                            <td valign="top">
                                <b><span i18n:translate="urban_investigationStart">from <span i18n:name="number" tal:content="repeat/inquiry/number"/></span>:</b>
                            </td>
                            <td width="2%"></td>
                            <td valign="top" tal:define="start_date python: inquiry['start_date'];
                                                         url python: inquiry['url']">
                                <a href="#" tal:condition="python: start_date and url" tal:attributes="href url" tal:content="python: start_date">Content</a>
                                <span tal:condition="python: start_date and not url" tal:content="python: start_date">end date</span>
                                <span tal:condition="not: start_date" class="discreet" i18n:translate="content_none">None</span>
                            </td>
                        </tr>
                        <tr>
                            <td valign="top"><b><span i18n:translate="urban_label_investigationEnd">to</span>:</b></td>
                            <td width="2%"></td>
                            <td valign="top" tal:define="end_date python: inquiry['end_date'];
                                                         url python: inquiry['url']">
                                <a href="#" tal:condition="python: end_date and url" tal:attributes="href url" tal:content="python: end_date">Content</a>
                                <span tal:condition="python: end_date and not url" tal:content="python: end_date">end date</span>
                                <span tal:condition="not: end_date" class="discreet" i18n:translate="content_none">None</span>
                            </td>
                        </tr>
                        </tal:inquiries>
                    </table>
                </fieldset>
            </td>
        </tr>
        <tr>
            <td valign="top" width=50%>
                <fieldset><legend i18n:translate="legend_details">Details</legend>
                    <table metal:define-slot="detail_slot" class="no-style-table" cellspacing=0 cellpadding=0 width=100%
                           tal:define="default_exclude python: ['workLocations', 'architects', 'geometricians', 'notaries', 'foldermanagers'];
                                       exclude exclude|default_exclude">
                        <tal:loop repeat="field view/getDescriptionFields">
                            <tr tal:define="fieldname field/getName;
                                            nullvalue python: field.get(context) == ''">

                                <tal:normal_field condition="python: fieldname not in exclude">
                                    <td valign="top"><b><span tal:content="string:urban_label_${fieldname}" i18n:translate=""></span>:</b></td>
                                    <td width="2%"></td>
                                    <td valign="top">
                                        <metal:myfield use-macro="python:here.widget(fieldname, mode='view')" />
                                        <span tal:condition="nullvalue" class="discreet" i18n:translate="content_none">None</span>
                                    </td>
                                </tal:normal_field>

                                <tal:foldermanagers condition="python: fieldname == 'foldermanagers'">
                                    <td valign="top"><b><span i18n:translate="urban_label_foldermanagers">Treating agent</span>:</b></td>
                                    <td width="2%"></td>
                                    <td valign="top"><div metal:use-macro="here/@@licencemacros/urbanFolderManagerMacro" /></td>
                                </tal:foldermanagers>

                                <metal:special_fields define-slot="special_fields">
                                </metal:special_fields>

                            </tr>
                        </tal:loop>
                    </table>
                </fieldset>
            </td>
            <td width="1%"></td>
            <td metal:define-slot="address_and_parcels_slot" valign="top" width=49%>
                <fieldset tal:define="workLocations context/getWorkLocations"><legend i18n:translate="urban_label_workLocations">Work locations</legend>
                    <div tal:condition="workLocations"><metal:myfield use-macro="python:here.widget('workLocations', mode='view')" /></div>
                        <span tal:condition="not: workLocations" class="discreet" i18n:translate="content_none">None</span>
                </fieldset>
                <metal:representatives define-slot="representatives">
                </metal:representatives>
                <fieldset><legend i18n:translate="concerned_parcels">Concerned parcel(s)</legend>
                    <div metal:use-macro="here/@@globalmacros/urbanParcelsMacro" />
                </fieldset>
            </td>
        </tr>
    </table>
</div>


<div metal:define-macro="road_macro" i18n:domain="urban">
    <table class="no-style-table" cellspacing=0 cellpadding=0 width=100%>
        <tal:loop repeat="field view/getRoadFields">
            <tr tal:define="fieldname field/getName;
                            nullvalue python: field.get(context) == ''">
                <td valign="top"><b><span tal:content="string:urban_label_${fieldname}" i18n:translate=""></span>:</b></td>
                <td width="2%"></td>
                <td valign="top"><metal:myfield use-macro="python:here.widget(fieldname, mode='view')" />
                    <span tal:condition="nullvalue" class="discreet" i18n:translate="content_none">None</span>
                </td>
            </tr>
        </tal:loop>
    </table>
</div>


<div metal:define-macro="location_macro" i18n:domain="urban">
    <table class="no-style-table" cellspacing=0 cellpadding=0 width=100%
           tal:define="exclude python: ['isInPCA', 'pca', 'isInSubdivision', 'parcellings', 'subdivisionDetails']" >

        <tal:loop repeat="field view/getLocationFields">
            <tr tal:define="fieldname field/getName;
                            nullvalue python: field.get(context) == ''">

                <tal:normal_field condition="python: fieldname not in exclude">
                    <td valign="top"><b><span tal:content="string:urban_label_${fieldname}" i18n:translate=""></span>:</b></td>
                    <td width="2%"></td>
                    <td valign="top">
                        <metal:myfield use-macro="python:here.widget(fieldname, mode='view')" />
                        <span tal:condition="nullvalue" class="discreet" i18n:translate="content_none">None</span>
                    </td>
                </tal:normal_field>

                <tal:subdivision condition="python: fieldname == 'isInSubdivision'">
                    <td valign="top"><b><span i18n:translate="urban_label_isInSubdivision">In subdivision?</span>:</b></td>
                    <td width="2%"></td>
                    <td width="49%" valign="top" valign="top" tal:define="isInSubdivision context/getIsInSubdivision">
                        <metal:myfield use-macro="python:here.widget('isInSubdivision', mode='view')" />
                        <tal:isInSubdivision condition="isInSubdivision">
                            <br />
                            <metal:myfield use-macro="python:here.widget('parcellings', mode='view')" />
                            <br />
                            <tal:block replace="structure context/getSubdivisionDetails" />
                        </tal:isInSubdivision>
                    </td>
                </tal:subdivision>

                <tal:pca condition="python: fieldname == 'isInPCA'">
                    <td valign="top"><b><span i18n:translate="urban_label_isInPCA">In PCA?</span>:</b></td>
                    <td width="2%"></td>
                    <td valign="top" tal:define="isInPCA context/getIsInPCA">
                        <metal:myfield use-macro="python:here.widget('isInPCA', mode='view')" />
                        <tal:isInPCA condition="isInPCA">
                            <br />
                            <metal:myfield use-macro="python:here.widget('pca', mode='view')" />
                        </tal:isInPCA>
                    </td>
                </tal:pca>
            </tr>
        </tal:loop>
    </table>

    <fieldset tal:condition="useTabbing"><legend i18n:translate="concerned_parcels">Concerned parcel(s)</legend>
        <div metal:use-macro="here/@@globalmacros/urbanParcelsMacro" />
    </fieldset>
</div>


<div metal:define-macro="peb_macro" i18n:domain="urban">
    <table class="no-style-table" cellspacing=0 cellpadding=0 width=100%>
        <tal:loop repeat="field view/getPebFields">
            <tr tal:define="fieldname field/getName;
                            nullvalue python: field.get(context) == ''">
                <td valign="top"><b><span tal:content="string:urban_label_${fieldname}" i18n:translate=""></span>:</b></td>
                <td width="2%"></td>
                <td valign="top"><metal:myfield use-macro="python:here.widget(fieldname, mode='view')" />
                    <span tal:condition="nullvalue" class="discreet" i18n:translate="content_none">None</span>
                </td>
            </tr>
        </tal:loop>
    </table>
</div>


<div metal:define-macro="investigation_and_advices_macro" i18n:domain="urban"
     tal:define="ctype python: context.portal_types.getTypeInfo('Inquiry');
                 inquiries view/getInquiriesForDisplay;
                 member context/@@plone_portal_state/member;">
    <fieldset tal:repeat="inquiry inquiries">
        <legend>
            <span class="contenttype-inquiry" i18n:translate="inquiry_title_and_number">
                Inquiry
                <span i18n:name="number" tal:content="repeat/inquiry/number"></span>
            </span>
        </legend>
        <tal:comment replace="nothing">
            Do not show the actions on the Licence object representing the first inquiry,
            only on following ones wich are real Inquiry objects
        </tal:comment>
        <tal:actions condition="python: not repeatindex == 0" define="repeatindex repeat/inquiry/index">
            <div metal:define-macro="urbanActionsMacro" i18n:domain="urban"
                 tal:define="member context/@@plone_portal_state/member;
                             actionsToHide actionsToHide|python:()">

                <div align="right">
                    <!-- Edit action -->
                    <tal:edit_action condition="python: member.has_permission('Modify portal content', inquiry)">
                        <a class="noPadding" tal:attributes="href python: inquiry.absolute_url() + '/edit'">
                            <img src="#" tal:attributes="src string:${portal_url}/edit.gif" title="label_edit" i18n:attributes="title" />
                        </a>
                    </tal:edit_action>

                    <!-- Own management of the "delete" action -->
                    <tal:delete_action condition="python: member.has_permission('Delete objects', inquiry)">
                        <a class="urbanDelete noPadding"
                           tal:attributes="href python: inquiry.absolute_url() + '/delete_confirmation'">
                            <!-- Icon -->
                            <img src="#" tal:attributes="src string:${portal_url}/delete_icon.gif" i18n:attributes="title" title="label_remove"
                                 onClick="javascript:confirmDeleteObject(this)" style="cursor:pointer"/>
                        </a>
                    </tal:delete_action>
                </div>
            </div>
        </tal:actions>
        <table class="no-style-table" cellspacing=0 cellpadding=0 width=100%
               tal:define="exclude python: ['solicitOpinionsTo']" >

            <tal:loop repeat="field view/getInquiryFields">
                <tr tal:define="fieldname field/getName;
                                nullvalue python: field.get(context) == ''">

                    <tal:normal_field condition="python: fieldname not in exclude">
                        <td valign="top"><b><span tal:content="string:urban_label_${fieldname}" i18n:translate=""></span>:</b></td>
                        <td width="2%"></td>
                        <td valign="top"><metal:myfield use-macro="python:here.widget(fieldname, mode='view')" />
                            <span tal:condition="nullvalue" class="discreet" i18n:translate="content_none">None</span>
                        </td>
                    </tal:normal_field>

                    <tal:opinions condition="python: fieldname == 'solicitOpinionsTo'">
                        <td valign="top"><b><span i18n:translate="urban_label_solicitOpinionsTo">Solicit opinion to</span>:</b></td>
                        <td width="2%"></td>
                        <td tal:define="opinionIds inquiry/getSolicitOpinionsTo" style="padding-top: 1em;">
                            <table tal:condition="opinionIds" cellspacing="0" cellpadding="0" width="100%" class="listing">
                                <thead>
                                    <tr>
                                        <th i18n:translate="urban_label_requestedOrganisation">Organisation</th>
                                        <th i18n:translate="urban_label_eventDate">Date</th>
                                        <th i18n:translate="urban_label_receiptDate">Receipt date</th>
                                        <th i18n:translate="urban_label_adviceAgreementLevel">Advice agreement level</th>
                                    </tr>
                                </thead>
                                <tbody tal:define="tool python: context.portal_urban">
                                    <tr tal:repeat="opinionId opinionIds">
                                        <tal:block define="opinion python: inquiry.getLinkedUrbanEventOpinionRequest(opinionId)">
                                            <tal:anEventIsLinked condition="python: opinion is not None">
                                                <td>
                                                    <a href="#" tal:attributes="href opinion/absolute_url" tal:content="python: inquiry.getSolicitOpinionValue(opinionId)">
                                                        Opinion request
                                                    </a>
                                                </td>
                                                <td tal:define="eventDate opinion/getEventDate">
                                                    <span class="#"
                                                          tal:attributes="class python: eventDate and 'plain' or 'discreet'"
                                                          tal:content="python: eventDate and tool.formatDate(eventDate, translatemonth=False) or 'content_none'"
                                                          i18n:translate="">None
                                                    </span>
                                                </td>
                                                <td tal:define="receiptDate opinion/getReceiptDate">
                                                    <span class="#"
                                                          tal:attributes="class python: receiptDate and 'plain' or 'discreet'"
                                                          tal:content="python: receiptDate and tool.formatDate(receiptDate, translatemonth=False) or 'content_none'"
                                                          i18n:translate="">None
                                                    </span>
                                                </td>
                                                <td tal:define="adviceAgreementLevel opinion/getAdviceAgreementLevel">
                                                    <span class="#"
                                                          tal:attributes="class python: adviceAgreementLevel and 'plain' or 'discreet'"
                                                          tal:content="python: adviceAgreementLevel and adviceAgreementLevel or 'content_none'"
                                                          i18n:translate="">None
                                                    </span>
                                                </td>
                                            </tal:anEventIsLinked>
                                            <tal:noEventIsLinked condition="python: opinion is None">
                                                <td tal:content="python: inquiry.getSolicitOpinionValue(opinionId)">Opinion request</td>
                                                <td><span class="discreet" i18n:translate="content_none">None</span></td>
                                                <td><span class="discreet" i18n:translate="content_none">None</span></td>
                                                <td><span class="discreet" i18n:translate="content_none">None</span></td>
                                            </tal:noEventIsLinked>
                                        </tal:block>
                                    </tr>
                                </tbody>
                            </table>
                        </td>
                    </tal:opinions>
                </tr>
           </tal:loop>
           <tal:comment replace="nothing">Link to the UrbanEventInquiry if exists</tal:comment>
           <tr>
               <td valign="top"><b><span i18n:translate="urban_linked_urbaneventinquiry">Linked urban event inquiry</span>:</b></td>
               <td width="2%"></td>
               <td valign="top"
                   tal:define="linkedUrbanEventInquiry python: inquiry.getLinkedUrbanEventInquiry();">
                   <a tal:condition="python: linkedUrbanEventInquiry"
                      href="#" tal:attributes="href python:linkedUrbanEventInquiry.absolute_url()"
                      i18n:translate="urban_link_to_the_linked_urbaneventinquiry">
                          Click here to access the linked urban event inquiry
                   </a>
                   <span tal:condition="python: not linkedUrbanEventInquiry" class="discreet" i18n:translate="content_no_urbaneventinquiry">
                           There is no UrbanEventInquiry linked to this inquiry
                   </span>
               </td>
           </tr>
        </table>
    </fieldset>
    <br />
    <form tal:condition="python: member.has_permission('urban: Add Inquiry', context)"
          i18n:domain="urban" name="quickAdd"
          tal:attributes="action python: context.absolute_url() + '/createObject'"
          action="createObject" method="post">
        <input type="hidden" name="type_name" value="#" tal:attributes="value ctype/id" />
        <input type="submit" class="contenttype-inquiry button-inquiry" id="event" value="add_an_inquiry" i18n:attributes="value" />
    </form>
</div>


<div metal:define-macro="urbanEventsMacro" i18n:domain="urban">
    <table cellspacing=0 cellpadding=0 width=100%>
        <tr>
            <td tal:define="eventTypes view/getUrbanEventTypes">
                <form action="createUrbanEvent" method="POST"
                      tal:condition="view/canAddUrbanEvent">
                    <input type='hidden' name="urban_folder_uid" tal:attributes="value here/UID" value=''>
                        <select name="urban_event_type_uid">
                            <tal:loopEventType repeat="eventType eventTypes">
                                <option tal:attributes="value eventType/UID" value='' tal:content="eventType/Title">
                                </option>
                            </tal:loopEventType>
                        </select>
                    <input class="urbanButton contenttype-urbanevent button-urbanevent" type="submit" i18n:attributes="value" value="Add an event">
                </form>
                <p class="discreet" tal:condition="not: eventTypes" i18n:translate="urban_no_eventtype_defined">
                    No event type is defined in the configuration for this element
                </p>
                <br />
            </td>
        </tr>
        <tr>
            <td>
                <div>
                    <tal:listing content="structure view/renderEventsListing" />
                </div>
            </td>
        </tr>
    </table>
</div>


<div metal:define-macro="urbanAdvicesEventsMacro" i18n:domain="urban">
    <div tal:condition="view/canAddAllAdvices" >
        <fieldset>
            <legend i18n:translate="folder_advice">Folder advices</legend>
            <table cellspacing=0 cellpadding=0 width=100%>
                <tr>
                    <td>
                        <form action="createAllAdvices" method="POST">
                            <input class="urbanButton contenttype-urbanevent button-urbanevent" type="submit" value="Add all advices"
                                   i18n:attributes="value">
                        </form>
                        <div class="discreet">
                            <span i18n:translate="add_every_advices_descr">This will automatically generate following advices:</span>&nbsp;
                            <span tal:content="view/getAdviceTitles" />
                        </div>
                    </td>
                </tr>
            </table>
        </fieldset>
     </div>
</div>
