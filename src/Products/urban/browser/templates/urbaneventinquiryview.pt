<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="urban">
<head>
<metal:block fill-slot="top_slot"
             tal:define="member context/@@plone_portal_state/member;
                         border python: member.has_permission('Modify portal content', context) and 'enable_border' or 'disable_border';
                         dummy python:request.set(border, 1);" />
</head>

<body>
<div metal:fill-slot="main">
<metal:main_macro define-macro="main">
<metal:body define-macro="body_macro" tal:define="useTabbing python: True;
                                                  member context/@@plone_portal_state/member;
                                                  recipients context/getRecipients;
                                                  linkedUrbanEventType view/getUrbaneventtypes;
                                                  global parcels view/getParcels;">

<metal:titleWithIcon use-macro="here/urban_macros/macros/titleWithIcon" />

<div tal:replace="structure provider:plone.belowcontenttitle" />

<tal:comment replace="nothing">Go back...</tal:comment>
<metal:listing use-macro="here/urban_macros/macros/goBackToMacro" />

<div id="urbanViewWithTabbing" tal:condition="useTabbing">
<dl class="formTabs enableFormTabbing">
<dt class="formTab" id="fieldsetlegend-event_inquiry_documents" i18n:translate="event_inquiry_documents"><span>Description</span></dt>
<dd id="fieldset-event_inquiry_documents">
<table width=100%>
    <tr valign="top">
        <td width=35%>
        <metal:listing use-macro="context/@@urbanevent-macros/urbanEventDataMacro" />

        <fieldset tal:define="inqdata view/getInquiryData" tal:condition="inqdata"><legend i18n:translate="inquiry_data">Inquiry data</legend>
        <p class="discreet" i18n:translate="urban_linked_inquiry_help">Here above are data defined for the inquiry.  If you want to change these informations, click on the name of the linked inquiry here above.</p>
        <tal:comment replace="nothing">Keep context as name of the obj here as some widget rendering will fail if not...</tal:comment>
        <table class="no-style-table" tal:define="context python: inqdata[0];
                           fields python: inqdata[1];">
         <tr valign="top">
          <td>
           <strong i18n:translate="urban_label_linked_inquiry">Linked inquiry</strong>:&nbsp;&nbsp;&nbsp;&nbsp;
          </td>
          <td>
           <a href="#" tal:attributes="href view/getLinkToTheInquiries" tal:content="view/getLinkedInquiryTitle">Linked inquiry title and number</a>
          </td>
         </tr>
         <tal:evtfield repeat="field fields">
         <tr valign="top">
          <td>
           <strong i18n:translate="" tal:content="python: 'urban_label_' + field">Inquiry field label</strong>:&nbsp;&nbsp;&nbsp;&nbsp;
          </td>
          <tal:manage_show_nc_if_needed define="value python: getattr(context, field)">
           <td tal:condition="value">
            <metal:myfield use-macro="python: context.widget(field, mode='view')" />
           </td>
           <td tal:condition="not: value">
            <span tal:condition="not: value" class="discreet" i18n:translate="content_none">None</span>
           </td>
          </tal:manage_show_nc_if_needed>
         </tr>
         </tal:evtfield>
       </table>
       </fieldset>

        <metal:listing use-macro="context/@@urbanevent-macros/urbanEventGenerateDocumentMacro" />
        </td>
        <td width=65%>
        <fieldset><legend i18n:translate="event_linked_documents">Event linked documents</legend>
          <div tal:define="tool python: context.portal_urban;
                           batch python: tool.queryCatalog(batch=True, specificSearch='searchLinkedDocuments', context=context, theObjects=False, batchlen=50);
                           showedCols python: ('Title',);
                           showActions python: True;">
          <metal:listing use-macro="here/urban_macros/macros/listing" />
          </div>
        </fieldset>

        </td>
    </tr>
    <tr valign="top">
        <td width=35%>
         <metal:listing use-macro="context/@@urbanevent-macros/urbanEventAddAnnexMacro" />
        </td>
        <td width=65%>
         <fieldset><legend i18n:translate="event_linked_annexes">Event linked annexes</legend>
          <div tal:define="tool python: context.portal_urban;
                           batch python: tool.queryCatalog(batch=True, specificSearch='searchLinkedAnnexes', context=context, theObjects=False, batchlen=50);
                           showedCols python: ('Title', 'created', 'Creator', );
                           showActions python: True;">
          <metal:listing use-macro="here/urban_macros/macros/listing" />
          </div>
         </fieldset>
        </td>
    </tr>
</table>
</dd>

<dt class="formTab" id="fieldsetlegend-event_inquiry_claimants" i18n:translate="event_inquiry_claimants"><span>Claimants</span></dt>
<dd id="fieldset-event_inquiry_claimants">
<form tal:condition="python: member.has_permission('urban: Add Contact', context)"
      tal:define="ctype python: context.portal_types.getTypeInfo('Claimant');
                  member context/@@plone_portal_state/member;"
      i18n:domain="urban"
      name="quickAdd" tal:attributes="action python: context.absolute_url() + '/createObject'"
      action="createObject" method="post">
 <img src="#" title="#" tal:attributes="src python: ctype.getIconExprObject(); title ctype/description"
      i18n:attributes="title" />
 <input type="hidden" name="type_name" value="#" tal:attributes="value ctype/id" />
 <input type="submit" class="context" id="event" value="add_a_claimant" i18n:attributes="value" />
 <br /><br />
</form>
<div tal:define="claimants context/getClaimants;">
 <table width=100% class="listing" style="margin-bottom: 0;">
  <thead>
   <tr>
    <th colspan="4">
     <span i18n:translate="number_of_claimants">Number of claimants</span> :
     <strong><span tal:content="python: len(claimants)" /></strong>
    </th>
   </tr>
  </thead>
 </table>
  <div tal:define="tool python: context.portal_urban;
                   Batch python:modules['Products.CMFPlone'].Batch;
                   b_start request/b_start|python:0;
                   batch python: Batch(claimants, 25, b_start);
                   showedCols python: ('Title', );
                   colsLabels python: {'Title': 'claimant_data'};
                   showActions python: True;">
  <metal:listing use-macro="here/urban_macros/macros/listing" />
  </div>
</div>
</dd>

<dt class="formTab" id="fieldsetlegend-urbaneventinquiry_recipients" i18n:translate="event_inquiry_recipients"><span>Recipients</span></dt>
<dd id="fieldset-urbaneventinquiry_recipients">
<tal:block condition="python: member.has_permission('Modify portal content', context)
                              and linkedUrbanEventType.getEventTypeType() == 'Products.urban.interfaces.IInquiryEvent'">
  <form action="addInvestigationPO">
   <input type="submit" tal:attributes="value string:Rechercher les propriétaires situés dans un rayon de 50m" />
  </form>
  <form name="quickAdd" action="createRecipientCadatsre" method="post"
        tal:condition="python: member.has_permission('urban: Add RecipientCadastre', context)"
        tal:attributes="action python: context.absolute_url() + '/createObject?type_name=RecipientCadastre'">
   <input type="submit" id="event" value="Add recipientcadastre manually"  i18n:attributes="value" />
  </form>
  <p>&nbsp;</p>
</tal:block>
<tal:recipients condition="recipients">
    <table width=100% class="listing" style="margin-bottom: 0;">
    <thead>
    <tr>
    <th colspan="4">
    <span i18n:translate="number_of_recipients">Number of recipients</span> :
    <strong><span tal:content="python: len(recipients)" /></strong>
    </th>
    </tr>
    </thead>
    </table>
    <div tal:define="tool python: context.portal_urban;
                     Batch python:modules['Products.CMFPlone'].Batch;
                     b_start request/b_start|python:0;
                     batch python: Batch(recipients, 50, b_start);
                     showedCols python: ('name', 'adr1', 'street',);
                     showActions python: True;">
     <metal:listing use-macro="here/urban_macros/macros/listing" />
    </div>
</tal:recipients>
<tal:block condition="python: context.REQUEST.get('doc_uid') != None">
<tal:block define="docObj python:context.uid_catalog(UID=context.REQUEST.get('doc_uid'))[0]">
<Script tal:content="python:'document.location = \''+docObj.getObject().absolute_url()+'/external_edit\';'" />
</tal:block>
</tal:block>

</dd>

</div>

 </metal:body>
</metal:main_macro>
</div>
</body>
</html>
