<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="urban">
<head>
<metal:block fill-slot="top_slot"
             tal:define="member context/@@plone_portal_state/member;
                         border python: member.has_role('Manager') and 'enable_border' or 'disable_border';
                         dummy python:request.set(border, 1);" />

<tal:block condition="context/getRecipients">
    <div metal:fill-slot="style_slot">
        <!--link rel="stylesheet" href="map.css" type="text/css" media="screen" charset="utf-8" /-->
    </div>
</tal:block>
</head>

<body>
<div metal:fill-slot="main">
<metal:main_macro define-macro="main">
<metal:body define-macro="body_macro" tal:define="recipients context/getRecipients;
                                                  linkedUrbanEventType context/getUrbaneventtypes">
<h1 class="documentFirstHeading" tal:content="here/Title"/>
<div tal:replace="structure provider:plone.belowcontenttitle" />
<!-- Back to the build licence... -->
<br />
<a class="no_underline" href=".."><img src="goback.png" />&nbsp;<span i18n:translate="back_to_licence">Go back to the licence</span></a>

<table width=100%>
    <tr valign="top">
        <td width=35%>
        <metal:listing use-macro="here/urban_macros/macros/urbanEventDataMacro" />
         
        <fieldset tal:define="inqdata view/getInquiryData" tal:condition="inqdata"><strong><legend i18n:translate="inquiry_data">Inquiry data</legend></strong>
        <tal:comment replace="nothing">Keep context as name of the obj here as some widget rendering will fail if not...</tal:comment>
        <table tal:define="context python: inqdata[0];
                           fields python: inqdata[1];">
         <tr valign="top">
           <td colspan=2>
            <p class="discreet" i18n:translate="urban_linked_inquiry_help">Here above are data defined for the inquiry.  If you want to change these informations, click on the name of the linked inquiry here above.</p>
           </td>
         </tr>
         <tr valign="top">
          <td>
           <u><strong i18n:translate="urban_label_linked_inquiry">Linked inquiry</strong>:</u>&nbsp;&nbsp;&nbsp;&nbsp;
          </td>
          <td>
           <a href="#" tal:attributes="href python: context.portal_type == 'BuildLicence' and context.absolute_url() + '/#fieldsetlegend-urban_investigation_and_advices' or context.absolute_url()" tal:content="view/getLinkedInquiryTitle">Linked inquiry title and number</a>
          </td>
         </tr>
         <tal:evtfield repeat="field fields">
         <tr valign="top">
          <td>
           <u><strong i18n:translate="" tal:content="python: 'urban_label_' + field">Inquiry field label</strong>:</u>&nbsp;&nbsp;&nbsp;&nbsp;
          </td>
          <tal:manage_show_nc_if_needed define="value python: getattr(context, field)">
           <td tal:condition="value">
            <metal:myfield use-macro="python: context.widget(field, mode='view')" />
           </td>
           <td tal:condition="not: value">
            <span tal:condition="not: value" class="discreet" i18n:translate="content_none">None</span>
           </td>
          </tal:manage_show_nc_if_needed>
         </tr>
         </tal:evtfield>
       </table>
       </fieldset>

        <metal:listing use-macro="here/urban_macros/macros/urbanEventGenerateDocumentMacro" />
        <metal:listing use-macro="here/urban_macros/macros/urbanEventAddAnnexMacro" />
        </td>
        <td width=65%>
        <fieldset><strong><legend i18n:translate="event_linked_documents">Event linked documents</legend><strong>
        <div tal:define="specificSearch python: 'searchLinkedDocuments';
                         tool python: context.portal_urban;
                         showedCols python: ('Title', 'created', 'Creator', );
                         topic python: None;
                         showActions python: True;
                         theObjects python: False;
                         batchlen python: 50">
         <metal:listing use-macro="here/urban_macros/macros/listing" />
        </div>
        </fieldset>
        </td>
    </tr>
</table>

<tal:block condition="linkedUrbanEventType/getSpecialFunctionName">
<a tal:attributes="href linkedUrbanEventType/getSpecialFunctionUrl" tal:content="linkedUrbanEventType/getSpecialFunctionName"/><br><br>
</tal:block>

<tal:block condition="recipients"
           define="specificSearch python: 'searchRecipients';
                   tool python: context.portal_urban;
                   showedCols python: ('getParcelsForDisplay', 'name', 'street', 'adr1', );
                   topic python: None;
                   showActions python: True;
                   theObjects python: True;
                   batchlen python: 50">
    <table width=100% class="listing">
    <thead>
    <tr>
    <th colspan="4">
    <span i18n:translate="number_of_recipients">Number of recipients</span> : 
    <strong><span tal:content="python: len(recipients)" /></strong>
    </th>
    </tr>
    </thead>
    </table>
    <div metal:use-macro="here/urban_macros/macros/listing" />
</tal:block>

<tal:carto condition="recipients">
<center>
<br /><br />
   <table border=0 width=100%>
       <tr>
           <td width=70%><div id="map" class="smallmap"></div></td>
           <td width=30%><IFRAME name="prcinfosframe" src="" width=400 height=500 scrolling=auto frameborder=0 > </IFRAME></td>
       </tr>
   </table>
</center>
<br><br>
</tal:carto>

<tal:block condition="python: context.REQUEST.get('doc_uid') != None">
<tal:block define="docObj python:context.uid_catalog(UID=context.REQUEST.get('doc_uid'))[0]">
<Script tal:content="python:'document.location = \''+docObj.getObject().absolute_url()+'/external_edit\';'" />
</tal:block>
</tal:block>

 </metal:body>
</metal:main_macro>
</div>
</body>
</html>
