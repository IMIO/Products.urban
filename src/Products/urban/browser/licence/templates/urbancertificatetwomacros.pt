<metal:description define-macro="description_macro" i18n:domain="urban">

    <tal:vars define="exclude python:[
                                 'title', 'workLocations', 'notaryContact', 'specificFeatures',
                                 'customSpecificFeatures', 'townshipSpecificFeatures'
                             ];">
        <metal:parent_call use-macro="here/@@licencetabs-macros/description_macro">

            <metal:proprietaries fill-slot="applicant_slot">
                <metal:proprietaries_macro use-macro="here/@@licencemacros/urbanProprietariesMacro" />
            </metal:proprietaries>

            <metal:representatives fill-slot="representatives">
                <metal:representatives_macro use-macro="here/@@licencemacros/urbanNotariesMacro" />
                <metal:applicants_macro use-macro="here/@@licencemacros/urbanApplicantsMacro" />
            </metal:representatives>

            <fieldset metal:fill-slot="custom_left_fieldset"><legend i18n:translate="legend_specific_features">Specific features</legend>
                <metal:spf_fieldset use-macro="here/@@fielddisplay-macros/spf_fieldset" />
            </fieldset>
        </metal:parent_call>
    </tal:vars>

</metal:description>


<metal:road define-macro="road_macro" i18n:domain="urban">

    <tal:vars define="custom python:['roadSpecificFeatures'];">
        <metal:parent_call use-macro="here/@@licencetabs-macros/road_macro" />
    </tal:vars>

</metal:road>


<metal:location define-macro="location_macro" i18n:domain="urban">

    <tal:vars define="custom python:['locationSpecificFeatures'];">
        <metal:parent_call use-macro="here/@@licencetabs-macros/location_macro" />
    </tal:vars>

</metal:location>

<metal:inquiry define-macro="investigation_and_advices_macro" i18n:domain="urban">
    <div metal:use-macro="here/@@licencetabs-macros/investigation_and_advices_macro" />
</metal:inquiry>


<div class="licence-column" metal:define-macro="advices_macro" i18n:domain="urban"
     tal:define="ctype python: context.portal_types.getTypeInfo('Inquiry');
                 inquiries view/getInquiriesForDisplay;
                 member context/@@plone_portal_state/member;">
    <fieldset tal:repeat="inquiry inquiries">
        <legend i18n:translate="urban_label_solicitOpinionsTo">Solicit opinion to</legend>
        <table class="no-style-table" cellspacing=0 cellpadding=0 width=100%
               tal:define="exclude python: ['solicitOpinionsTo']" >
            <tr tal:repeat="field view/getAdviceFields">
                <tal:vars define="fieldname field/getName">

                <tal:normal_field condition="python: fieldname not in exclude">
                    <td valign="top"><b><span tal:content="string:urban_label_${fieldname}" i18n:translate=""></span>:</b></td>
                    <td width="10px"></td>
                    <td valign="top"><metal:myfield use-macro="python:here.widget(fieldname, mode='view')" />
                        <span tal:condition="nullvalue" class="discreet" i18n:translate="content_none">None</span>
                    </td>
                </tal:normal_field>

                <tal:opinions condition="python: fieldname == 'solicitOpinionsTo'">
                    <td tal:define="opinionIds inquiry/getSolicitOpinionsTo" style="padding-top: 1em;" colspan="3">
                        <table tal:condition="opinionIds" cellspacing="0" cellpadding="0" width="100%" class="listing">
                            <thead>
                                <tr>
                                    <th i18n:translate="urban_label_requestedOrganisation">Organisation</th>
                                    <th i18n:translate="urban_label_askingDate">Asking Date</th>
                                    <th i18n:translate="urban_label_receiptDate">Receipt date</th>
                                    <th i18n:translate="urban_label_externalDecision">Advice</th>
                                </tr>
                            </thead>
                            <tbody tal:define="tool python: context.portal_urban">
                                <tr tal:repeat="opinionId opinionIds">
                                    <tal:block define="opinion python: inquiry.getLinkedUrbanEventOpinionRequest(opinionId)">
                                        <tal:anEventIsLinked condition="python: opinion is not None">
                                            <td>
                                                <a href="#" tal:attributes="href opinion/absolute_url" tal:content="python: inquiry.getSolicitOpinionValue(opinionId)">
                                                    Opinion request
                                                </a>
                                            </td>
                                            <td tal:define="eventDate opinion/getEventDate">
                                                <span class="#"
                                                      tal:attributes="class python: eventDate and 'plain' or 'discreet'"
                                                      tal:content="python: eventDate and tool.formatDate(eventDate, translatemonth=False) or 'content_none'"
                                                      i18n:translate="">None
                                                </span>
                                            </td>
                                            <td tal:define="receiptDate opinion/getReceiptDate">
                                                <span class="#"
                                                      tal:attributes="class python: receiptDate and 'plain' or 'discreet'"
                                                      tal:content="python: receiptDate and tool.formatDate(receiptDate, translatemonth=False) or 'content_none'"
                                                      i18n:translate="">None
                                                </span>
                                            </td>
                                            <td tal:define="advice python: here.getValueForTemplate('externalDecision', obj=opinion)">
                                                <span class="#"
                                                      tal:attributes="class python: advice and 'plain' or 'discreet'"
                                                      tal:content="python: advice and advice or 'content_none'"
                                                      i18n:translate="">None
                                                </span>
                                            </td>
                                        </tal:anEventIsLinked>
                                        <tal:noEventIsLinked condition="python: opinion is None">
                                            <td tal:content="python: inquiry.getSolicitOpinionValue(opinionId)">Opinion request</td>
                                            <td><span class="discreet" i18n:translate="content_none">None</span></td>
                                            <td><span class="discreet" i18n:translate="content_none">None</span></td>
                                            <td><span class="discreet" i18n:translate="content_none">None</span></td>
                                        </tal:noEventIsLinked>
                                    </tal:block>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tal:opinions>
                </tal:vars>
            </tr>
        </table>
    </fieldset>
    <br />
</div>

<div class="licence-column" metal:define-macro="inquiry_macro" i18n:domain="urban"
     tal:define="ctype python: context.portal_types.getTypeInfo('Inquiry');
                 inquiries view/getInquiriesForDisplay;
                 member context/@@plone_portal_state/member;">
    <fieldset tal:repeat="inquiry inquiries">
        <legend>
            <span class="contenttype-inquiry" i18n:translate="inquiry_title_and_number">
                Inquiry
                <span i18n:name="number" tal:content="repeat/inquiry/number"></span>
            </span>
        </legend>
        <tal:comment replace="nothing">
            Do not show the actions on the Licence object representing the first inquiry,
            only on following ones wich are real Inquiry objects
        </tal:comment>
        <tal:actions condition="python: not repeatindex == 0" define="repeatindex repeat/inquiry/index">
            <div metal:define-macro="urbanActionsMacro" i18n:domain="urban"
                 tal:define="member context/@@plone_portal_state/member;
                             actionsToHide actionsToHide|python:()">

                <div align="right">
                    <!-- Edit action -->
                    <tal:edit_action condition="python: member.has_permission('Modify portal content', inquiry)">
                        <a class="noPadding" tal:attributes="href python: inquiry.absolute_url() + '/edit'">
                            <img src="#" tal:attributes="src string:${portal_url}/edit.png" title="label_edit" i18n:attributes="title" />
                        </a>
                        </tal:edit_action>

                        <!-- Own management of the "delete" action -->
                        <tal:delete_action condition="python: member.has_permission('Delete objects', inquiry)">
                                <a class="urbanDelete noPadding"
                                tal:attributes="href python: inquiry.absolute_url() + '/delete_confirmation'">
                                <!-- Icon -->
                                <img src="#" tal:attributes="src string:${portal_url}/delete_icon.png" i18n:attributes="title" title="label_remove"
                                        onClick="javascript:confirmDeleteObject(this)" style="cursor:pointer"/>
                                </a>
                        </tal:delete_action>
                        </div>
                </div>
                </tal:actions>
                <table class="no-style-table" cellspacing=0 cellpadding=0 width=100%
                tal:define="exclude python: []" >
                <tal:loop repeat="field view/getInquiryFields">
                        <tr tal:define="fieldname field/getName;
                                        nullvalue python: field.get(context) == ''">

                        <tal:normal_field condition="python: fieldname not in exclude">
                                <td valign="top"><b><span tal:content="string:urban_label_${fieldname}" i18n:translate=""></span>:</b></td>
                                <td width="10px"></td>
                                <td valign="top"><metal:myfield use-macro="python:here.widget(fieldname, mode='view')" />
                                <span tal:condition="nullvalue" class="discreet" i18n:translate="content_none">None</span>
                                </td>
                        </tal:normal_field>
                        </tr>
                </tal:loop>
                <tal:comment replace="nothing">Link to the UrbanEventInquiry if exists</tal:comment>
                <tr>
                <td valign="top"><b><span i18n:translate="urban_linked_urbaneventinquiry">Linked urban event inquiry</span>:</b></td>
                <td width="10px"></td>
                <td valign="top"
                        tal:define="linkedUrbanEventInquiry python: inquiry.getLinkedUrbanEventInquiry();">
                        <a tal:condition="python: linkedUrbanEventInquiry"
                        href="#" tal:attributes="href python:linkedUrbanEventInquiry.absolute_url()"
                        i18n:translate="urban_link_to_the_linked_urbaneventinquiry">
                                Click here to access the linked urban event inquiry
                        </a>
                        <span tal:condition="python: not linkedUrbanEventInquiry" class="discreet" i18n:translate="content_no_urbaneventinquiry">
                                There is no UrbanEventInquiry linked to this inquiry
                        </span>
                </td>
                </tr>
                </table>
        </fieldset>
        <br />
        <metal:custom_add_inquiry define-slot="custom_add_inquiry">
                <form tal:condition="python: member.has_permission('urban: Add Inquiry', context)"
                i18n:domain="urban" name="quickAdd"
                tal:attributes="action python: context.absolute_url() + '/createObject'"
                action="createObject" method="post">
                <input type="hidden" name="type_name" value="#" tal:attributes="value ctype/id" />
                <input type="submit" class="context apButton contenttype-inquiry" id="event" value="add_an_inquiry" i18n:attributes="value" />
                </form>
        </metal:custom_add_inquiry>
</div>
